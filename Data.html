
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management System (Firebase) - Optimized</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <!-- New Login Page Styles -->
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --primary-light: #4895ef;
            --secondary: #f72585;
            --dark: #212529;
            --light: #f8f9fa;
            
            /* Existing App Variables (can co-exist) */
            --success: #4cc9f0;
            --admin: #7209b7; 
            --manager: #f72585; 
            --employee: #4cc9f0; 
            --task-assigned: #3b82f6; 
            --task-completed: #10b981; 
            --task-missed: #ef4444; 
            --appreciation: #f59e0b;
            --task-pending-next-step: #8b5cf6;
        }

        body { 
            background-color: #f5f7fb; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow-x: hidden; 
            min-height: 100vh;
        }
        
        .auth-container {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: ''; position: absolute; width: 300px; height: 300px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); top: -100px; left: -100px;
            animation: float 15s infinite linear;
        }
        
        .auth-container::after {
            content: ''; position: absolute; width: 200px; height: 200px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.08); bottom: -50px; right: -50px;
            animation: float 12s infinite linear reverse;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.98); border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); width: 100%; max-width: 420px;
            overflow: hidden; z-index: 10; backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2); transform: scale(1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .auth-card:hover { transform: scale(1.01); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25); }
        
        .auth-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            padding: 1.5rem; text-align: center; position: relative; overflow: hidden;
        }
        
        .auth-header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px;
            background: linear-gradient(90deg, var(--secondary), transparent);
            animation: progress 2s infinite linear;
        }
        
        .auth-header h3 { color: white; margin: 0; font-weight: 600; position: relative; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        
        .auth-body { padding: 2rem; }
        
        .login-icon {
            width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
            color: white; font-size: 2rem; animation: pulse 2s infinite;
        }
        
        .auth-body .form-label { font-weight: 500; color: var(--dark); margin-bottom: 0.5rem; }
        .auth-body .form-control { padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid #e0e0e0; transition: all 0.3s ease; }
        .auth-body .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25); }
        .auth-body .input-group-text { background-color: transparent; border-right: none; }
        .auth-body .input-with-icon { border-left: none; }
        .auth-body .password-container { position: relative; }
        .auth-body .password-toggle { cursor: pointer; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #6c757d; transition: all 0.3s ease; }
        .auth-body .password-toggle:hover { color: var(--primary); }
        
        .auth-body .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; padding: 0.75rem;
            border-radius: 10px; font-weight: 500; letter-spacing: 0.5px;
            transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
            position: relative; overflow: hidden;
        }
        
        .auth-body .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4); }
        .auth-body .btn-primary:active { transform: translateY(0); }
        .auth-body .btn-primary::after { content: ''; position: absolute; top: -50%; left: -60%; width: 200%; height: 200%; background: rgba(255, 255, 255, 0.2); transform: rotate(30deg); transition: all 0.3s ease; }
        .auth-body .btn-primary:hover::after { left: 100%; }
        
        .setup-link { color: var(--primary); text-decoration: none; font-weight: 500; transition: all 0.3s ease; position: relative; display: inline-block; }
        .setup-link:hover { color: var(--primary-dark); }
        .setup-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -2px; left: 0; background: var(--primary); transition: width 0.3s ease; }
        .setup-link:hover::after { width: 100%; }
        
        .network-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; }
        .network-node { position: absolute; width: 12px; height: 12px; background: rgba(255, 255, 255, 0.15); border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); }
        .network-connection { position: absolute; height: 1px; background: rgba(255, 255, 255, 0.1); transform-origin: left center; z-index: 1; }
        .data-packet { position: absolute; width: 6px; height: 6px; background: rgba(255, 255, 255, 0.6); border-radius: 50%; z-index: 2; transform: translate(-50%, -50%); }
        .server-icon { position: absolute; color: rgba(255, 255, 255, 0.2); font-size: 24px; transform: translate(-50%, -50%); z-index: 3; }
        .network-pulse { position: absolute; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 50%; transform: translate(-50%, -50%); opacity: 0; }
        
        @keyframes float { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-100vh) rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); } }
        @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes movePacket { 0% { transform: translate(var(--startX), var(--startY)); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translate(var(--endX), var(--endY)); opacity: 0; } }
        @keyframes nodePulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        /* Responsive adjustments */
        @media (max-width: 576px) { .auth-card { margin: 1rem; max-width: 100%; } }
    </style>

    <!-- Existing Application Styles -->
    <style>
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { background: linear-gradient(to bottom, var(--primary), var(--secondary)); width: 250px; min-height: 100vh; color: white; box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1); transition: all 0.3s; z-index: 100; }
        .sidebar-header { padding: 20px; background: rgba(0, 0, 0, 0.15); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .user-info { padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .user-role { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; }
        .role-admin { background: var(--admin); } .role-manager { background: var(--manager); } .role-employee { background: var(--employee); }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar-menu li a { color: rgba(255, 255, 255, 0.8); padding: 12px 20px; display: block; text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-menu li a:hover, .sidebar-menu li a.active { background: rgba(255, 255, 255, 0.1); color: white; border-left: 3px solid white; }
        .sidebar-menu li a i { width: 25px; text-align: center; margin-right: 10px; }
        .main-content { flex: 1; padding: 20px; background-color: #f0f4f8; position: relative; transition: all 0.3s;}
        .top-bar { background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-title { font-weight: 600; color: var(--dark); margin: 0; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .card-header { background: white; border-bottom: 1px solid rgba(0, 0, 0, 0.05); padding: 15px 20px; border-radius: 12px 12px 0 0 !important; font-weight: 600; }
        .employee-card { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #e9ecef; }
        .employee-card:last-child { border-bottom: none; }
        .employee-avatar { 
            width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; display: flex; 
            align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; margin-right: 15px; flex-shrink: 0;
            object-fit: cover; border: 2px solid rgba(255,255,255,0.2);
        }
        .employee-info { flex: 1; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .mobile-menu-btn { display: none; background: none; border: none; color: var(--primary); font-size: 1.5rem; }
        @media (max-width: 992px) { 
            .sidebar { position: fixed; left: -250px; } 
            .sidebar.active { left: 0; } 
            .mobile-menu-btn { display: block; } 
            .main-content { margin-left: 0; }
        }
        .stat-card { 
            text-align: center; padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;
            cursor: pointer; transition: all 0.2s ease-in-out; display: flex; flex-direction: column; justify-content: center;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .stat-1 { background: linear-gradient(135deg, #4361ee, #3a0ca3); } .stat-2 { background: linear-gradient(135deg, #f72585, #b5179e); }
        .stat-3 { background: linear-gradient(135deg, #4cc9f0, #4895ef); } .stat-4 { background: linear-gradient(135deg, #7209b7, #560bad); }
        .spinner-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert-container { position: fixed; top: 20px; right: 20px; z-index: 1056; width: 350px; }
        .table-hover tbody tr:hover { background-color: rgba(67, 97, 238, 0.05); }
        .table-responsive { overflow-x: auto; }
        .badge-success { background-color: #2ecc71 !important; } .badge-warning { background-color: #f39c12 !important; } .badge-danger { background-color: #e74c3c !important; } .badge-info { background-color: #3498db !important; } .badge-primary { background-color: var(--primary) !important; }
        .task-card { border-left: 4px solid var(--task-assigned); margin-bottom: 15px; border-radius: 8px; transition: all 0.3s ease-in-out; }
        .task-card.manager-clickable:hover {
            cursor: pointer;
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .task-card.completed { border-left-color: var(--task-completed); }
        .task-card.missed { border-left-color: var(--task-missed); }
        .task-card.pending-next-step { border-left-color: var(--task-pending-next-step); }
        .task-card.highlight { background-color: #fffbe6; border-left-color: var(--appreciation); }
        .task-status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .task-assigned { background-color: rgba(59, 130, 246, 0.15); color: var(--task-assigned); }
        .task-completed { background-color: rgba(16, 185, 129, 0.15); color: var(--task-completed); }
        .task-missed { background-color: rgba(239, 68, 68, 0.15); color: var(--task-missed); }
        .task-pending-next-step { background-color: rgba(139, 92, 246, 0.15); color: var(--task-pending-next-step); }
        .appreciation-card { background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05)); border-left: 4px solid var(--appreciation); }
        .appreciation-badge { background: var(--appreciation); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .task-actions .btn { margin-right: 5px; }
        .task-form .form-label { font-weight: 500; }
        .analytics-chart { height: 300px; position: relative; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .password-strength { height: 5px; margin-top: 5px; border-radius: 3px; background-color: #e9ecef; }
        .password-strength.strength-0 { background: #e74c3c; width: 20%; }
        .password-strength.strength-1 { background: #f39c12; width: 40%; }
        .password-strength.strength-2 { background: #f1c40f; width: 60%; }
        .password-strength.strength-3 { background: #2ecc71; width: 80%; }
        .password-strength.strength-4 { background: #27ae60; width: 100%; }
        .attendance-widget { background: linear-gradient(135deg, #ffffff, #f1f4f8); border: none; }
        .attendance-widget .card-body { padding: 1.25rem 1rem; }
        .live-clock-display { font-size: 1.8rem; font-weight: 600; color: var(--dark); font-family: 'Courier New', Courier, monospace; }
        .live-date-display { font-size: 0.9rem; color: #6c757d; margin-top: 0; margin-bottom: 10px; }
        .work-timer-display { margin-bottom: 10px; transition: all 0.3s ease; height: 55px; }
        .work-timer-display.hidden { opacity: 0; visibility: hidden; height: 0; margin-bottom: 0; }
        .work-timer-display span { font-size: 0.75rem; font-weight: 500; color: #6c757d; letter-spacing: 0.5px; text-transform: uppercase; }
        .work-timer-display h3 { font-size: 1.9rem; font-weight: 700; color: var(--task-completed); margin-top: -5px; margin-bottom: 0; }
        .main-clock-btn { 
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary); 
            background-color: #fff; color: var(--primary); font-size: 1.5rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: all 0.4s ease-in-out; 
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2); margin: 0 auto; 
        }
        .main-clock-btn i { font-size: 1.8rem; margin-bottom: 3px; transition: transform 0.3s; }
        .main-clock-btn .btn-text { font-size: 0.9rem; font-weight: 500; }
        .main-clock-btn:not(.clocked-in):hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3); }
        .main-clock-btn.clocked-in { background-color: var(--task-completed); color: #fff; border-color: transparent; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        .main-clock-btn.completed { background-color: #e9ecef; color: #6c757d; border-color: #ced4da; cursor: not-allowed; box-shadow: none; }
        .main-clock-btn.completed:hover { transform: none; box-shadow: none; }
        .clock-status-text { font-size: 1rem; font-weight: 500; color: #495057; }
        .clock-details { background-color: #e8f4fd; border-radius: 8px; padding: 8px 12px; display: inline-block; font-size: 0.85rem; color: #333; transition: all 0.3s; }
        .clock-details.hidden { opacity: 0; visibility: hidden; transform: translateY(-10px); }
        .report-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; padding: 15px; background-color: #f8f9fa; border-top: 1px solid #dee2e6; margin-top: 10px; }
        .summary-item { text-align: center; padding: 10px; border-radius: 8px; color: white; }
        .summary-item h5 { margin-bottom: 0; font-size: 1.5rem; }
        .summary-item p { margin-bottom: 0; font-size: 0.8rem; text-transform: uppercase; }
        .summary-present { background-color: var(--task-completed); }
        .summary-leave { background-color: var(--task-missed); }
        .summary-wfh { background-color: var(--appreciation); }
        .summary-absent { background-color: #6c757d; }
        .summary-weekend { background-color: #adb5bd; }
        .summary-item.custom-leave { background-color: var(--secondary); }

        .birthday-card { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #e9ecef; }
        .birthday-card:last-child { border-bottom: none; }
        .birthday-date { text-align: right; min-width: 90px; }
        .birthday-date .day { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .birthday-date .month { font-size: 0.8rem; color: #6c757d; text-transform: uppercase; }
        .birthday-today-badge { background-color: var(--manager) !important; color: white; font-weight: 600; }

        /* ====== NOTIFICATION STYLES ====== */
        .notification-item {
            display: block; padding: 10px 15px; text-decoration: none; color: var(--dark);
            border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s;
        }
        .notification-item:hover { background-color: #f8f9fa; }
        .notification-item.unread { background-color: #e8f4fd; font-weight: 500; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item .message { font-size: 0.9rem; font-weight: normal; color: #6c757d; white-space: normal; }
        .notification-item .time { font-size: 0.75rem; color: #adb5bd; }
        #notification-dropdown-menu { padding: 0; }

        /* ====== GOAL CARD STYLES ====== */
        .goal-card {
            border-left: 4px solid var(--secondary);
            margin-bottom: 1rem;
        }
        .goal-card .card-body {
            padding: 1rem;
        }

        /* ====== CALENDAR COLOR STYLES ====== */
        .table-row-weekend td {
            background-color: #f8f9fa !important; /* A light grey for weekends */
            color: #6c757d;
        }

        .table-row-holiday td {
            background-color: #e6fcf5 !important; /* A light green for holidays */
            color: #0c6448;
            font-weight: 500;
        }
        
        .table-hover > tbody > tr.table-row-weekend:hover > *,
        .table-hover > tbody > tr.table-row-holiday:hover > * {
            background-color: #e9ecef !important;
        }

        /* ====== MARQUEE STYLE ====== */
        .info-marquee-container {
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary)); 
            color: white; 
            font-weight: 500;
        }

    </style>
</head>

<body>
    <div id="alert-container" class="alert-container"></div>
    <div id="loading-spinner" class="spinner-container d-none"><div class="spinner"></div></div>

    <!-- REPLACED AUTH SCREEN -->
    <div id="auth-screen" class="auth-container">
        <!-- Networking animation container -->
        <div class="network-container" id="networkContainer"></div>

        <div class="auth-card animate__animated animate__fadeIn">
            <div class="auth-header">
                <h3>Employee Management System</h3>
            </div>
            <div class="auth-body">
                <div class="mb-4 text-center">
                    <div class="login-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <h4 class="mt-3 fw-bold">Welcome Back</h4>
                    <p class="text-muted">Please sign in to access your dashboard</p>
                </div>
                <form id="login-form" onsubmit="return false;">
                    <div id="login-error" class="alert alert-danger d-none animate__animated animate__shakeX"></div>
                    <div class="mb-4">
                        <label class="form-label">Email Address</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input type="email" id="login-email" class="form-control input-with-icon" placeholder="Enter your email" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Password</label>
                        <div class="password-container">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" id="login-password" class="form-control input-with-icon" placeholder="Enter your password" required>
                            </div>
                            <span class="password-toggle" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Remember me</label>
                        </div>
                        <a href="#" class="text-decoration-none text-primary">Forgot password?</a>
                    </div>
                    <button type="button" id="login-btn" class="btn btn-primary w-100 py-3 fw-bold">
                        <span class="btn-text">Sign In</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <div class="text-center mt-4">
                        <a href="#" id="setup-link" class="setup-link">No account? Click here to setup demo data</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- EXISTING DASHBOARD (UNCHANGED) -->
    <div id="dashboard" class="d-none">
        <div class="dashboard-container">
            <div class="sidebar">
                <!-- MODIFIED: Sidebar Header with Logo -->
                <div class="sidebar-header">
                    <div class="d-flex align-items-center">
                        <img src="" id="sidebar-logo" alt="Company Logo" style="height: 35px; margin-right: 10px; display: none; border-radius: 4px;">
                        <h5 class="mb-0 text-white">Ay-Technologies</h5>
                        <label for="logo-upload-input" id="logo-upload-label" class="ms-auto manager-admin-only d-none" style="cursor: pointer;" title="Change Logo">
                            <i class="fas fa-edit"></i>
                        </label>
                        <input type="file" id="logo-upload-input" class="d-none" accept="image/png, image/jpeg, image/svg+xml">
                    </div>
                </div>
                <div class="user-info">
                    <div class="d-flex align-items-center">
                        <img src="" id="sidebar-avatar" class="employee-avatar" alt="User Avatar" loading="lazy">
                        <div class="ms-3"><h6 class="mb-0" id="user-name"></h6><span class="user-role" id="user-role"></span></div>
                    </div>
                </div>
                <ul class="sidebar-menu" id="main-menu">
                    <li><a href="#" class="active" data-view="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a href="#" data-view="attendance"><i class="fas fa-calendar-check"></i> Attendance</a></li>
                    <li><a href="#" data-view="leave"><i class="fas fa-house-user"></i> Leave & WFH</a></li>
                    <li><a href="#" data-view="tasks"><i class="fas fa-tasks"></i> Tasks</a></li>
                    <li><a href="#" data-view="appreciations"><i class="fas fa-medal"></i> Appreciations</a></li>
                    <!-- NEW SECTIONS ADDED -->
                    <li><a href="#" data-view="activities"><i class="fas fa-clipboard-list"></i> Activities</a></li>
                    <li><a href="#" data-view="learning-goals"><i class="fas fa-bullseye"></i> Learning Goals</a></li>
                    <li><a href="#" data-view="analytics"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                    <li class="admin-only"><a href="#" data-view="employees"><i class="fas fa-users-cog"></i> Employees</a></li>
                    <li><a href="#" data-view="profile"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="#" data-view="password"><i class="fas fa-lock"></i> Change Password</a></li>
                    <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
            <div class="main-content">
                <div class="top-bar">
                    <button class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
                    <h4 class="dashboard-title" id="view-title">Dashboard</h4>
                    <div class="d-flex align-items-center">
                        <!-- ====== NOTIFICATION DROPDOWN ====== -->
                        <div class="dropdown">
                            <button class="btn btn-light position-relative" type="button" id="notification-bell" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-bell"></i>
                                <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                                    0
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="notification-bell" id="notification-dropdown-menu" style="width: 350px;">
                                <li class="p-2 border-bottom"><h6 class="dropdown-header mb-0">Notifications</h6></li>
                                <li><div id="notification-list" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Notifications will be injected here by JS -->
                                </div></li>
                                <li id="notification-footer" class="p-2 text-center border-top d-none">
                                    <a href="#" id="mark-all-read-btn" class="small">Mark all as read</a>
                                </li>
                                <li id="no-notification-placeholder" class="text-center p-4 text-muted">
                                    No new notifications.
                                </li>
                            </ul>
                        </div>
                        <!-- ====== END NOTIFICATION DROPDOWN ====== -->
                    </div>
                </div>
                
                <div class="view-content" id="dashboard-view">
                    
                    <!-- ================================== -->
                    <!-- ==== UPDATED TOP ROW OF DASHBOARD ==== -->
                    <!-- ================================== -->
                    <div class="row align-items-stretch mb-4">
                        <!-- Clock-in Widget -->
                        <div class="col-lg-5 mb-4 mb-lg-0">
                            <div class="card attendance-widget text-center h-100">
                                <div class="card-body d-flex flex-column justify-content-center py-4">
                                    <div id="live-clock" class="live-clock-display">10:30:45 AM</div>
                                    <p id="live-date" class="live-date-display"></p>
                                    <div id="work-timer-display" class="work-timer-display hidden">
                                        <span>Work Duration</span>
                                        <h3 id="work-duration">0h 0m 0s</h3>
                                    </div>
                                    <button id="main-clock-btn" class="main-clock-btn">
                                        <i class="fas fa-play"></i>
                                        <span class="btn-text">Clock In</span>
                                    </button>
                                    <p id="clock-status-text" class="clock-status-text mt-3 mb-2">You are currently clocked out.</p>
                                    <div id="clock-details" class="clock-details mt-1 hidden">
                                        <span>Clocked In At: <strong id="clock-in-time">--:--</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stat Cards -->
                        <div class="col-lg-7">
                            <div class="row h-100">
                                <div class="col-sm-6 mb-4">
                                    <div class="stat-card stat-1 h-100" data-stat="total">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <h3 class="mb-0" id="total-employees">0</h3>
                                        <p class="mb-0">Total Employees</p>
                                    </div>
                                </div>
                                <div class="col-sm-6 mb-4">
                                    <div class="stat-card stat-2 h-100" data-stat="present">
                                        <i class="fas fa-calendar-day fa-2x mb-2"></i>
                                        <h3 class="mb-0" id="present-today">0</h3>
                                        <p class="mb-0">Present Today</p>
                                    </div>
                                </div>
                                <div class="col-sm-6 mb-4 mb-sm-0">
                                    <div class="stat-card stat-3 h-100" data-stat="leave">
                                        <i class="fas fa-plane-departure fa-2x mb-2"></i>
                                        <h3 class="mb-0" id="on-leave">0</h3>
                                        <p class="mb-0">On Leave</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="stat-card stat-4 h-100" data-stat="wfh">
                                        <i class="fas fa-laptop-house fa-2x mb-2"></i>
                                        <h3 class="mb-0" id="wfh-today">0</h3>
                                        <p class="mb-0">Working Remotely</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ================================== -->
                    <!-- ==== DYNAMIC MARQUEE SECTION ==== -->
                    <!-- ================================== -->
                    <div class="card mb-4" id="marquee-container">
                        <div class="card-body p-2 info-marquee-container">
                            <marquee behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();" id="dashboard-marquee">
                                <!-- Dynamic content will be injected here by JS -->
                            </marquee>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-lg-7 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Your Active Tasks</span>
                                    <button class="btn btn-sm btn-outline-primary" id="add-task-btn">Add Task</button>
                                </div>
                                <div class="card-body p-0" id="user-tasks-container" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-lg-5 mb-4">
                            <div class="card" id="employee-status-widget">
                                <div class="card-header">Today's Employee Status</div>
                                <div class="card-body p-0" id="employee-status-container" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                            <div class="card d-none" id="admin-attendance-widget">
                                <div class="card-header">Daily Attendance Report</div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-hover table-sm mb-0">
                                            <thead><tr><th>Name</th><th>Status</th><th>Times</th><th>Action</th></tr></thead>
                                            <tbody id="admin-attendance-table-dashboard"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card mt-4" id="birthday-widget">
                                <div class="card-header">
                                    <i class="fas fa-birthday-cake me-2 text-primary"></i>Upcoming Birthdays
                                </div>
                                <div class="card-body p-0" id="upcoming-birthdays-container" style="max-height: 300px; overflow-y: auto;">
                                </div>
                            </div>
                            <!-- NEW HOLIDAY WIDGET -->
                            <div class="card mt-4" id="holiday-widget">
                                <div class="card-header">
                                    <i class="fas fa-gifts me-2 text-success"></i>Upcoming Holidays
                                </div>
                                <div class="card-body p-0" id="upcoming-holidays-container" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Holiday data will be injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-2">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Recent Appreciations</span>
                            <button class="btn btn-sm btn-outline-primary manager-admin-only" id="add-appreciation-btn">Give Appreciation</button>
                        </div>
                        <div class="card-body" id="recent-appreciations"></div>
                    </div>
                </div>
                
                <div class="view-content d-none" id="attendance-view">
                    <!-- NEW: Attendance Marquee -->
                    <div class="card mb-4">
                        <div class="card-body p-2 info-marquee-container">
                            <marquee behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();" id="attendance-marquee">
                                <!-- Attendance marquee content here -->
                            </marquee>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Your Attendance Records</span>
                            <div>
                                <select class="form-select form-select-sm d-inline-block w-auto" id="attendance-month"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select>
                                <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="attendance-year"></select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead><tr><th>Date</th><th>Clock In</th><th>Clock Out</th><th>Total Hours</th><th>Status</th></tr></thead>
                                    <tbody id="attendance-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- UPDATED LEAVE VIEW -->
                <div class="view-content d-none" id="leave-view">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card mb-4">
                                <div class="card-header">Apply for Leave/WFH</div>
                                <div class="card-body">
                                    <form id="leave-form">
                                        <div class="mb-3">
                                            <label class="form-label">Request Type</label>
                                            <select class="form-select" id="leave-type">
                                                <option value="casual">Casual Leave</option>
                                                <option value="sick">Sick Leave</option>
                                                <option value="wfh">Work From Home</option>
                                                <option value="wedding">Wedding Leave</option>
                                                <option value="bereavement">Bereavement Leave</option>
                                                <option value="maternity">Maternity Leave</option>
                                                <option value="paternity">Paternity Leave</option>
                                                <option value="lop">Loss of Pay</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="leave-start" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="leave-end" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Reason</label>
                                            <textarea class="form-control" id="leave-reason" rows="3" required></textarea>
                                            <small class="form-text text-muted">Note: Special leaves require manager approval and may need documentation.</small>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <span class="btn-text">Submit Request</span>
                                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <div class="card admin-manager-only">
                                <div class="card-header">Pending Approvals</div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-hover">
                                            <thead><tr><th>Employee</th><th>Type</th><th>Date</th><th>Reason</th><th>Actions</th></tr></thead>
                                            <tbody id="pending-approvals-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card mb-4">
                                <div class="card-header">Your Leave Balances (2025)</div>
                                <div class="card-body" id="leave-balance-container">
                                    <!-- Balance info injected here by JS -->
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">Your Past Requests</div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-hover">
                                            <thead><tr><th>Type</th><th>Dates</th><th>Status</th></tr></thead>
                                            <tbody id="leave-requests-table"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-content d-none" id="tasks-view">
                    <!-- NEW: Tasks Marquee -->
                    <div class="card mb-4">
                        <div class="card-body p-2 info-marquee-container">
                            <marquee behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();" id="tasks-marquee">
                                <!-- Tasks marquee content here -->
                            </marquee>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Team Tasks</span>
                                    <div>
                                        <select class="form-select form-select-sm d-inline-block w-auto" id="task-filter">
                                            <option value="all">All Tasks</option>
                                            <option value="assigned">Assigned</option>
                                            <option value="pending-next-step">Pending Next Step</option>
                                            <option value="completed">Completed</option>
                                            <option value="missed">Missed</option>
                                        </select>
                                        <button class="btn btn-sm btn-primary ms-2" id="add-task-btn-2"><i class="fas fa-plus"></i> Add Task</button>
                                    </div>
                                </div>
                                <div class="card-body" id="team-tasks-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="view-content d-none" id="appreciations-view"><div class="row" id="appreciations-row"><div class="col-md-6" id="appreciation-form-col"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>Give Appreciation</span></div><div class="card-body"><form id="appreciation-form"><div class="mb-3"><label class="form-label">Employee</label><select class="form-select" id="appreciation-employee" required><option value="">Select Employee</option></select></div><div class="mb-3"><label class="form-label">Task (Optional)</label><select class="form-select" id="appreciation-task"></select></div>
                <!-- AI INTEGRATION START -->
                <div class="mb-3">
                    <label class="form-label">Appreciation Note</label>
                    <textarea class="form-control" id="appreciation-note" rows="3" placeholder="Write your appreciation message..." required></textarea>
                    <button type="button" class="btn btn-sm btn-outline-info mt-2" id="generate-appreciation-btn">
                        <i class="fas fa-magic me-1"></i> Generate with AI
                    </button>
                </div>
                <!-- AI INTEGRATION END -->
                <div class="mb-3 form-check"><input type="checkbox" class="form-check-input" id="appreciation-public" checked><label class="form-check-label">Make this appreciation public to the team</label></div><button type="submit" class="btn btn-primary">
                    <span class="btn-text">Submit Appreciation</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button></form></div></div></div><div class="col-md-6" id="appreciation-list-col"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>Team Appreciations</span><div class="btn-group"><select class="form-select form-select-sm" id="appreciation-filter"><option value="all">All Appreciations</option><option value="public">Public Only</option><option value="mine" id="appreciation-filter-mine">My Appreciations</option></select></div></div><div class="card-body" id="team-appreciations-container" style="max-height: 500px; overflow-y: auto;"></div></div></div></div></div>
                
                <!-- ================================== -->
                <!-- ==== UPDATED ACTIVITIES VIEW ==== -->
                <!-- ================================== -->
                <div class="view-content d-none" id="activities-view">
                    <!-- NEW: Activities Marquee -->
                    <div class="card mb-4">
                        <div class="card-body p-2 info-marquee-container">
                            <marquee behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();" id="activities-marquee">
                                <!-- Activities marquee content here -->
                            </marquee>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Development Activities</span>
                            <button class="btn btn-primary btn-sm" id="add-activity-btn">
                                <i class="fas fa-plus me-1"></i> Log New Activity
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Activity Name</th>
                                            <th>Topic</th>
                                            <th>Duration</th>
                                            <th>Attendance</th>
                                            <th class="manager-admin-only">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activities-table-body">
                                        <!-- Activity rows will be injected here by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================================== -->
                <!-- ==== LEARNING GOALS VIEW ==== -->
                <!-- ================================== -->
                <div class="view-content d-none" id="learning-goals-view">
                     <!-- NEW: Goals Marquee -->
                    <div class="card mb-4">
                        <div class="card-body p-2 info-marquee-container">
                            <marquee behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();" id="goals-marquee">
                                <!-- Goals marquee content here -->
                            </marquee>
                        </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span id="learning-goals-title">Your Learning Goals</span>
                            <div>
                                <select class="form-select form-select-sm d-inline-block w-auto manager-admin-only" id="goal-employee-filter">
                                    <!-- Employee filter for managers -->
                                </select>
                                <!-- AI INTEGRATION START -->
                                <button class="btn btn-info btn-sm" id="suggest-goals-btn">
                                    <i class="fas fa-lightbulb me-1"></i> AI Suggestions
                                </button>
                                <!-- AI INTEGRATION END -->
                                <button class="btn btn-primary btn-sm" id="add-goal-btn">
                                    <i class="fas fa-plus me-1"></i> Add New Goal
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-calendar-week me-2"></i>This Week's Goals</div>
                                <div class="card-body" id="goals-this-week-container" style="max-height: 60vh; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-calendar-alt me-2"></i>This Month's Goals</div>
                                <div class="card-body" id="goals-this-month-container" style="max-height: 60vh; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-calendar-minus me-2"></i>Previous Month's Goals</div>
                                <div class="card-body" id="goals-previous-month-container" style="max-height: 60vh; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-content d-none" id="analytics-view"><div class="row"><div class="col-md-8"><div class="card"><div class="card-header">Weekly Attendance Analytics</div><div class="card-body"><div class="analytics-chart"><canvas id="attendance-chart"></canvas></div></div></div></div><div class="col-md-4"><div class="card"><div class="card-header">Task Status Rate</div><div class="card-body"><div class="analytics-chart"><canvas id="tasks-chart"></canvas></div></div></div></div></div><div class="row mt-4"><div class="col-md-6"><div class="card"><div class="card-header">Leave & WFH Distribution</div><div class="card-body"><div class="analytics-chart"><canvas id="leave-chart"></canvas></div></div></div></div><div class="col-md-6"><div class="card"><div class="card-header">Monthly Performance</div><div class="card-body"><div class="analytics-chart"><canvas id="performance-chart"></canvas></div></div></div></div></div></div>
                <div class="view-content d-none" id="employees-view"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>Employee List</span><button class="btn btn-primary btn-sm" id="add-employee-btn"><i class="fas fa-plus me-1"></i> Add Employee</button></div><div class="card-body"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Name</th><th>Email</th><th>Department</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody id="employees-table"></tbody></table></div></div></div></div>
                <div class="view-content d-none" id="profile-view"><div class="card"><div class="card-header">Your Profile</div><div class="card-body"><div class="row"><div class="col-md-3 text-center"><img src="https://ui-avatars.com/api/?name=User+Name&background=4361ee&color=fff&size=120" alt="Profile" id="profile-pic-preview" class="profile-pic mb-3"><button type="button" id="change-photo-btn" class="btn btn-outline-primary btn-sm w-100">Change Photo</button><input type="file" id="profile-pic-input" class="d-none" accept="image/*"></div><div class="col-md-9"><form id="profile-form"><div class="row mb-3"><div class="col-md-6"><label class="form-label">First Name</label><input type="text" class="form-control" id="profile-first-name" required></div><div class="col-md-6"><label class="form-label">Last Name</label><input type="text" class="form-control" id="profile-last-name" required></div></div><div class="row mb-3"><div class="col-md-6"><label class="form-label">Email</label><input type="email" class="form-control" id="profile-email" required></div><div class="col-md-6"><label class="form-label">Phone</label><input type="tel" class="form-control" id="profile-phone"></div></div><div class="row mb-3"><div class="col-md-6"><label class="form-label">Department</label><select class="form-select" id="profile-department" required><!-- Options will be populated by JavaScript --></select></div><div class="col-md-6"><label class="form-label">Date of Birth</label><input type="date" class="form-control" id="profile-dob"></div></div><div class="mb-3"><label class="form-label">Address</label><textarea class="form-control" id="profile-address" rows="2"></textarea></div><button type="submit" class="btn btn-primary">
                    <span class="btn-text">Update Profile</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button></form></div></div></div></div></div>
                <div class="view-content d-none" id="password-view"><div class="card"><div class="card-header">Change Password</div><div class="card-body"><form id="password-form"><div class="mb-3"><label class="form-label">Current Password</label><input type="password" class="form-control" id="current-password" required></div><div class="mb-3"><label class="form-label">New Password</label><input type="password" class="form-control" id="new-password" required><div class="password-strength" id="password-strength"></div><small class="text-muted">Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.</small></div><div class="mb-3"><label class="form-label">Confirm New Password</label><input type="password" class="form-control" id="confirm-password" required></div><button type="submit" class="btn btn-primary">
                    <span class="btn-text">Change Password</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button></form></div></div></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="employeeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="employeeModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="employee-form" onsubmit="return false;"><input type="hidden" id="employee-id"><div class="row mb-3"><div class="col-md-6"><label class="form-label">First Name</label><input type="text" class="form-control" id="employee-first-name" required></div><div class="col-md-6"><label class="form-label">Last Name</label><input type="text" class="form-control" id="employee-last-name" required></div></div><div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="employee-email" required></div>
    
    <!-- MODIFIED: Department dropdown with an 'Add' button for admins -->
    <div class="mb-3">
        <label class="form-label">Department</label>
        <div class="input-group">
            <select class="form-select" id="employee-department" required>
                <option value="">Select...</option>
                <!-- Options will be populated by JavaScript -->
            </select>
            <button type="button" class="btn btn-outline-primary d-none" id="add-new-department-btn" title="Add New Department">+</button>
        </div>
    </div>

    <div class="mb-3"><label class="form-label">Role</label><select class="form-select" id="employee-role" required><option value="">Select...</option><option value="employee">Employee</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div><div class="mb-3" id="password-field-group"><label class="form-label">Password</label><input type="password" class="form-control" id="employee-password" required minlength="6"><small class="text-muted">Min. 6 characters.</small></div><div class="mb-3 d-none" id="status-field-group"><label class="form-label">Status</label><select class="form-select" id="employee-status"><option value="active">Active</option><option value="inactive">Inactive</option></select></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-employee-btn">
        <span class="btn-text">Save</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button></div></div></div></div>
    
    <!-- ================================== -->
    <!-- ==== MODIFIED TASK MODAL ==== -->
    <!-- ================================== -->
    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="taskModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="task-form"><input type="hidden" id="task-id"><div class="mb-3"><label class="form-label">Task Title</label><input type="text" class="form-control" id="task-title" required></div>
    <!-- AI INTEGRATION START -->
    <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea class="form-control" id="task-description" rows="3" required></textarea>
        <button type="button" class="btn btn-sm btn-outline-info mt-2" id="generate-task-desc-btn">
            <i class="fas fa-magic me-1"></i> Generate with AI
        </button>
    </div>
    <!-- AI INTEGRATION END -->
    <div class="row">
        <!-- Assignee Field UPDATED for Multiple Selections -->
        <div class="col-md-6 mb-3">
            <label class="form-label">Assign To</label>
            <select class="form-select" id="task-assignee" multiple required>
                <!-- Employee options will be populated by JS -->
            </select>
            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple people.</small>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Deadline</label>
            <input type="date" class="form-control" id="task-deadline" required>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Priority</label>
        <select class="form-select" id="task-priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
        </select>
    </div>
    
    <!-- NEW: Attachment Section -->
    <div class="mb-3">
        <label class="form-label">Attachment (Optional)</label>
        <div class="card p-2" style="background-color: #f8f9fa;">
            <div id="existing-attachment-info" class="mb-2"></div>
            <label for="task-attachment-file" class="form-label small">Upload a file (will replace existing)</label>
            <input class="form-control form-control-sm" type="file" id="task-attachment-file" accept="image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx">
            <div class="text-center my-2 small text-muted">OR</div>
             <label for="task-attachment-link" class="form-label small">Paste a link (will replace existing)</label>
            <input type="url" class="form-control form-control-sm" id="task-attachment-link" placeholder="https://example.com/document.pdf">
        </div>
    </div>
    
    </form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-task-btn">
        <span class="btn-text">Save Task</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button></div></div></div></div>

    <div class="modal fade" id="monthlyReportModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="reportModalTitle">Monthly Attendance Report</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div class="d-flex justify-content-end mb-3"><select class="form-select form-select-sm d-inline-block w-auto" id="report-month"></select><select class="form-select form-select-sm d-inline-block w-auto ms-2" id="report-year"></select></div><div id="report-table-container" class="table-responsive"></div><div id="report-summary-container"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>
    <div class="modal fade" id="statDetailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="statDetailModalTitle">Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-0" id="statDetailModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>
    
    <!-- ================================== -->
    <!-- ==== RE-ASSIGN TASK MODAL (FULLY UPDATED) ==== -->
    <!-- ================================== -->
    <div class="modal fade" id="reassignTaskModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Assign to Another Person</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="reassign-task-form" onsubmit="return false;"><input type="hidden" id="reassign-task-id"><div class="mb-3"><label class="form-label">Task Title</label><input type="text" class="form-control" id="reassign-task-title" readonly></div><div class="mb-3"><label class="form-label">Assign To</label><select class="form-select" id="reassign-task-assignee" required><option value="">Select Employee</option></select></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">New Deadline</label><input type="date" class="form-control" id="reassign-task-deadline" required></div></div><div class="mb-3"><label for="reassign-field-notes" class="form-label">Field Notes (for new assignee)</label><textarea class="form-control" id="reassign-field-notes" rows="3" placeholder="Add any context or instructions..."></textarea></div>
    
    <!-- NEW: Add/Update Attachment Section -->
    <div class="mb-3">
        <label class="form-label">Add/Update Attachment (Optional)</label>
        <div class="card p-2" style="background-color: #f8f9fa;">
            <label for="reassign-task-attachment-file" class="form-label small">Upload new file (replaces any existing one)</label>
            <input class="form-control form-control-sm" type="file" id="reassign-task-attachment-file" accept="image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx">
            <div class="text-center my-2 small text-muted">OR</div>
            <label for="reassign-task-attachment-link" class="form-label small">Paste a new link</label>
            <input type="url" class="form-control form-control-sm" id="reassign-task-attachment-link" placeholder="https://example.com/file.pdf">
        </div>
    </div>

    </form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-reassign-btn">
        <span class="btn-text">Assign Task</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button></div></div></div></div>

    <!-- ================================== -->
    <!-- ==== ACTIVITY MODAL (UPDATED) ==== -->
    <!-- ================================== -->
    <div class="modal fade" id="activityModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="activityModalTitle">Log New Activity</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="activity-form"><input type="hidden" id="activity-id"><div class="mb-3"><label class="form-label">Activity Name</label><input type="text" class="form-control" id="activity-name" placeholder="e.g., Leadership Training" required></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Date</label><input type="date" class="form-control" id="activity-date" required></div><div class="col-md-6 mb-3"><label class="form-label">Duration</label><input type="text" class="form-control" id="activity-duration" placeholder="e.g., 2 hours" required></div></div><div class="mb-3"><label class="form-label">Topic Covered</label><textarea class="form-control" id="activity-topic" rows="2" placeholder="Summary of what was taught" required></textarea></div><div class="mb-3"><label class="form-label">Attendance</label><select class="form-select" id="activity-attendance" multiple required><!- Employee options here --></select><small class="text-muted">Hold Ctrl/Cmd to select multiple employees.</small></div><div class="mb-3"><label class="form-label">Notes / Summary</label><textarea class="form-control" id="activity-notes" rows="3" placeholder="Key outcomes or feedback"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-activity-btn">
        <span class="btn-text">Save Activity</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button></div></div></div></div>
    
    <!-- ================================== -->
    <!-- ==== GOAL MODAL (UPDATED) ==== -->
    <!-- ================================== -->
    <div class="modal fade" id="goalModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="goalModalTitle">Add New Goal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="goal-form"><input type="hidden" id="goal-id"><div class="mb-3 manager-admin-only"><label class="form-label">Assign To</label><select class="form-select" id="goal-employee" required><! - Options here --></select></div><div class="mb-3"><label class="form-label">Goal Description</label><textarea class="form-control" id="goal-description" rows="3" required></textarea></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Assigned Date</label><input type="date" class="form-control" id="goal-assigned-date" required></div><div class="col-md-6 mb-3"><label class="form-label">Progress Status</label><select class="form-select" id="goal-status" required><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select></div></div><div class="mb-3"><label class="form-label">Review Comments</label><textarea class="form-control" id="goal-review" rows="2" placeholder="Final review or feedback..."></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="save-goal-btn">
        <span class="btn-text">Save Goal</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
    </button></div></div></div></div>

    <!-- AI INTEGRATION START: NEW MODAL FOR GOAL SUGGESTIONS -->
    <div class="modal fade" id="aiGoalSuggestionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-lightbulb me-2 text-warning"></i> AI Learning Goal Suggestions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Here are some AI-generated learning goal suggestions for <strong id="ai-goal-employee-name"></strong>. Click on a suggestion to use it.</p>
                    <div id="ai-goal-suggestions-container" class="list-group">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="regenerate-goals-btn">
                        <i class="fas fa-sync-alt me-1"></i> Regenerate
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- AI INTEGRATION END -->

    <!-- NEW: Employee Profile View Modal (Read-Only) -->
    <div class="modal fade" id="employeeProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Employee Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <img src="" alt="Profile" id="modal-profile-pic" class="profile-pic mb-3" loading="lazy">
                            <h5 class="mb-0" id="modal-profile-name"></h5>
                            <p class="text-muted" id="modal-profile-role"></p>
                        </div>
                        <div class="col-md-9">
                            <h6>Contact Information</h6>
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr>
                                        <td style="width: 120px;"><strong>Email</strong></td>
                                        <td id="modal-profile-email"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Phone</strong></td>
                                        <td id="modal-profile-phone"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Address</strong></td>
                                        <td id="modal-profile-address"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <hr>
                            <h6>Organization Details</h6>
                             <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr>
                                        <td style="width: 120px;"><strong>Department</strong></td>
                                        <td id="modal-profile-department"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Joined On</strong></td>
                                        <td id="modal-profile-join-date"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Status</strong></td>
                                        <td id="modal-profile-status"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
    
    <!-- ================================== -->
    <!-- ==== **OPTIMIZED** FIREBASE V9 SDKs ==== -->
    <!-- ================================== -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js" defer></script>
    
    <!-- ====== EMAILJS SDK ====== -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" defer></script>

    <script type="module">
        // ==============================================
        // ==== FIREBASE V9 INITIALIZATION & SETUP ====
        // ==============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, getDoc, addDoc, setDoc, updateDoc, deleteDoc, doc, 
            query, where, limit, onSnapshot, writeBatch, orderBy 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";


        // =================================================================================
        // TODO: STEP 1 - FIREBASE CONFIGURATION
        // =================================================================================
        // Replace the placeholder object below with your actual Firebase project's configuration.
        // You can find this in your Firebase project settings under "General".
        const firebaseConfig = {
            apiKey: "AIzaSyCt2gR1YgczCKMvHDBvRNpBlKye7KEUWCc",
            authDomain: "ay-technologies.firebaseapp.com",
            databaseURL: "https://ay-technologies-default-rtdb.firebaseio.com",
            projectId: "ay-technologies",
            storageBucket: "ay-technologies.appspot.com",
            messagingSenderId: "354048234520",
            appId: "1:354048234520:web:999d9dcc049f879670df6d",
            measurementId: "G-MQM871K6SK"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const firestore = getFirestore(firebaseApp);
        const storage = getStorage(firebaseApp);

        // =================================================================================
        // TODO: STEP 2 - EMAILJS CONFIGURATION (OPTIONAL)
        // =================================================================================
        // To enable email notifications, sign up at emailjs.com, create a service and 
        // a template, then replace the placeholder strings below.
        const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID'; // <-- REPLACE with your EmailJS Service ID
        const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID'; // <-- REPLACE with your EmailJS Template ID
        const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY'; // <-- REPLACE with your EmailJS Public Key

        /**
         * Sends an email notification using EmailJS.
         * @param {string} to_email - The recipient's email address.
         * @param {string} to_name - The recipient's name.
         * @param {string} subject - The email subject.
         * @param {string} message - The main content of the email.
         */
        async function sendEmailNotification(to_email, to_name, subject, message) {
            if (EMAILJS_SERVICE_ID === 'YOUR_SERVICE_ID' || !EMAILJS_TEMPLATE_ID === 'YOUR_TEMPLATE_ID' || !EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                console.warn("EmailJS credentials are not set. Skipping email notification.");
                return;
            }

            const templateParams = {
                to_email: to_email,
                to_name: to_name,
                subject: subject,
                message: message,
            };

            try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams, { publicKey: EMAILJS_PUBLIC_KEY });
                console.log(`Email notification sent successfully to ${to_email}`);
            } catch (error) {
                console.error(`Failed to send email to ${to_email}:`, error);
            }
        }


        // =================================================================================
        // TODO: STEP 3 - GEMINI AI CONFIGURATION (OPTIONAL)
        // =================================================================================
        // WARNING: Storing API keys in client-side code is highly insecure and should not 
        // be done in a production environment. This is for demonstration purposes only.
        // For a real application, this call MUST be made from a secure backend server.
        // Get your key from Google AI Studio.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // <-- REPLACE
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

        /**
         * Calls the Gemini API with a specific prompt.
         * @param {string} prompt The prompt to send to the AI.
         * @returns {Promise<string>} The generated text content from the AI.
         */
        async function callGemini(prompt) {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                showAlert("AI features are disabled. Please configure your Gemini API Key.", "warning");
                return null;
            }
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`AI API request failed with status ${response.status}. See console for details.`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    let text = data.candidates[0].content.parts[0].text;
                    // Basic cleanup
                    text = text.replace(/[*#]/g, ''); // Remove markdown like asterisks or hashtags
                    return text.trim();
                } else {
                    // Handle cases where the API returns a response but it's empty or blocked
                    const finishReason = data.candidates?.[0]?.finishReason;
                    if (finishReason === 'SAFETY' || finishReason === 'RECITATION') {
                         throw new Error("The AI-generated response was blocked due to safety or other policy reasons.");
                    }
                    throw new Error("Received an empty or invalid response from the AI.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showAlert(error.message || "An error occurred while contacting the AI assistant.", "danger");
                return null; // Return null to indicate failure
            }
        }
        
        // ==============================================
        // ==== APPLICATION CORE DATA ====
        // ==============================================

        const HOLIDAYS_2025 = [
            { date: '2025-01-01', occasion: 'New Year', day: 'Wednesday' },
            { date: '2025-01-13', occasion: 'Bhogi', day: 'Monday' },
            { date: '2025-01-14', occasion: 'Sankranthi', day: 'Tuesday' },
            { date: '2025-03-30', occasion: 'Ugadi', day: 'Sunday' },
            { date: '2025-03-31', occasion: 'Ramzan', day: 'Monday' },
            { date: '2025-08-15', occasion: 'Independence Day', day: 'Friday' },
            { date: '2025-08-27', occasion: 'Vinayaka Chavithi', day: 'Wednesday' },
            { date: '2025-10-02', occasion: 'Gandhi Jayanthi', day: 'Thursday' },
            { date: '2025-10-03', occasion: 'Day after Dussehra', day: 'Friday' },
            { date: '2025-10-20', occasion: 'Diwali', day: 'Monday' },
            { date: '2025-12-25', occasion: 'Christmas', day: 'Thursday' }
        ];

        const LEAVE_TYPES = {
            casual: "Casual Leave",
            sick: "Sick Leave",
            wfh: "Work From Home",
            wedding: "Wedding Leave",
            bereavement: "Bereavement Leave",
            maternity: "Maternity Leave",
            paternity: "Paternity Leave",
            lop: "Loss of Pay"
        };
        const ALL_LEAVE_KEYS = Object.keys(LEAVE_TYPES);

        // Global state and utility variables
        let currentUser = null;
        let appState = { 
            employees: [], 
            tasks: [], 
            leaves: [], 
            appreciations: [], 
            attendance: [], 
            activities: [], 
            learningGoals: [] 
        };
        let allDepartments = []; 
        let unsubscribeListeners = [];
        
        let employeeModal, taskModal, reassignTaskModal, monthlyReportModal, statDetailModal;
        let activityModal, goalModal, aiGoalSuggestionModal, employeeProfileModal;

        let workTimerInterval = null;
        let preselectAppreciation = null;
        
        const DOMElements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            authScreen: document.getElementById('auth-screen'),
            dashboard: document.getElementById('dashboard'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            viewLinks: document.querySelectorAll('.sidebar-menu a'),
            viewContents: document.querySelectorAll('.view-content'),
            viewTitle: document.getElementById('view-title'),
            employeeForm: document.getElementById('employee-form'),
            saveEmployeeBtn: document.getElementById('save-employee-btn'),
            addEmployeeBtn: document.getElementById('add-employee-btn'),
            setupLink: document.getElementById('setup-link'),
            addTaskBtn: document.getElementById('add-task-btn'),
            addTaskBtn2: document.getElementById('add-task-btn-2'),
            addAppreciationBtn: document.getElementById('add-appreciation-btn'),
            taskForm: document.getElementById('task-form'),
            saveTaskBtn: document.getElementById('save-task-btn'),
            saveReassignBtn: document.getElementById('save-reassign-btn'),
            appreciationForm: document.getElementById('appreciation-form'),
            leaveForm: document.getElementById('leave-form'),
            profileForm: document.getElementById('profile-form'),
            passwordForm: document.getElementById('password-form'),
            mainClockBtn: document.getElementById('main-clock-btn'),
            liveClock: document.getElementById('live-clock'),
            liveDate: document.getElementById('live-date'),
            clockStatusText: document.getElementById('clock-status-text'),
            clockDetails: document.getElementById('clock-details'),
            clockInTime: document.getElementById('clock-in-time'),
            workDuration: document.getElementById('work-duration'),
            workTimerDisplay: document.getElementById('work-timer-display'),
            sidebarLogo: document.getElementById('sidebar-logo'),
            logoUploadInput: document.getElementById('logo-upload-input'),
            addNewDepartmentBtn: document.getElementById('add-new-department-btn'),
            addActivityBtn: document.getElementById('add-activity-btn'),
            saveActivityBtn: document.getElementById('save-activity-btn'),
            addGoalBtn: document.getElementById('add-goal-btn'),
            saveGoalBtn: document.getElementById('save-goal-btn'),
            generateAppreciationBtn: document.getElementById('generate-appreciation-btn'),
            generateTaskDescBtn: document.getElementById('generate-task-desc-btn'),
            suggestGoalsBtn: document.getElementById('suggest-goals-btn'),
            regenerateGoalsBtn: document.getElementById('regenerate-goals-btn'),
        };

        const showLoader = () => DOMElements.loadingSpinner.classList.remove('d-none');
        const hideLoader = () => DOMElements.loadingSpinner.classList.add('d-none');

        // ==============================================
        // ==== OPTIMIZATION HELPER FUNCTIONS ====
        // ==============================================

        /**
         * Toggles the loading state of a button, showing/hiding a spinner.
         * @param {HTMLElement} button The button element.
         * @param {boolean} isLoading True to show loader, false to hide.
         * @param {string} [originalText] The original text of the button to restore.
         */
        function setButtonLoading(button, isLoading, originalText = '') {
            if (!button) return;
            const textElement = button.querySelector('.btn-text');
            const spinnerElement = button.querySelector('.spinner-border');

            if (isLoading) {
                button.disabled = true;
                if(textElement) textElement.classList.add('d-none');
                if(spinnerElement) spinnerElement.classList.remove('d-none');
            } else {
                button.disabled = false;
                if(textElement) textElement.classList.remove('d-none');
                if(spinnerElement) spinnerElement.classList.add('d-none');
            }
        }
        
        /**
         * Disables or enables all fields in a form.
         * @param {HTMLElement} formElement The form element.
         * @param {boolean} isEnabled True to enable, false to disable.
         */
        function setFormEnabled(formElement, isEnabled) {
            const formControls = formElement.querySelectorAll('input, select, textarea, button');
            formControls.forEach(control => {
                control.disabled = !isEnabled;
            });
        }


        // ==============================================
        // ==== HELPER FUNCTIONS ====
        // ==============================================

        function getLocalDateString(date = new Date()) {
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        }
        
        function getRemainingLeaveBalance(leaveType) {
            if (!currentUser || !appState.leaves) return 0;
            
            const balances = currentUser.leaveBalances || { casual: 12, sick: 6 };
            const totalBalance = balances[leaveType] || 0;
            const year = new Date().getFullYear();
            
            const usedDays = appState.leaves
                .filter(l => l.employeeId === currentUser.id && l.status === 'approved' && l.type === leaveType && new Date(l.startDate).getFullYear() === year)
                .reduce((acc, l) => {
                    const start = new Date(l.startDate);
                    const end = new Date(l.endDate);
                    if (isNaN(start.getTime()) || isNaN(end.getTime())) return acc;
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    return acc + diffDays;
                }, 0);

            return Math.max(0, totalBalance - usedDays);
        }
        
        function loadCurrentView() {
            const activeLink = document.querySelector('.sidebar-menu a.active');
            if (activeLink) {
                loadViewData(activeLink.dataset.view);
            }
        }


        // ==============================================
        // ==== FIREBASE DATA LAYER (V9) ====
        // ==============================================
        const db = {
            getCollection: async (collectionName) => {
                const snapshot = await getDocs(collection(firestore, collectionName));
                return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            },
            getDocument: async (collectionName, docId) => {
                const docRef = doc(firestore, collectionName, docId);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
            },
            addDocument: async (collectionName, data) => await addDoc(collection(firestore, collectionName), data),
            setDocument: async (collectionName, docId, data) => await setDoc(doc(firestore, collectionName, docId), data, { merge: true }),
            updateDocument: async (collectionName, docId, data) => await updateDoc(doc(firestore, collectionName, docId), data),
            deleteDocument: async (collectionName, docId) => await deleteDoc(doc(firestore, collectionName, docId)),

            getCurrentUser: () => JSON.parse(sessionStorage.getItem('currentUser')),
            setCurrentUser: (user) => {
                if (user) sessionStorage.setItem('currentUser', JSON.stringify(user));
                else sessionStorage.removeItem('currentUser');
            },
            
            init: async () => {
                const q = query(collection(firestore, 'employees'), limit(1));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    await db.reset();
                }
            },
            reset: async () => {
                showLoader();
                try {
                    const batch = writeBatch(firestore);
                    const collections = ['employees', 'tasks', 'appreciations', 'leaves', 'attendance', 'notifications', 'app_metadata', 'departments', 'activities', 'learningGoals'];
                    
                    for (const collectionName of collections) {
                        const snapshot = await getDocs(collection(firestore, collectionName));
                        snapshot.docs.forEach(d => batch.delete(d.ref));
                    }
                    
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    const dob_today = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const dob_in_5_days = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 5);
                    const dob_in_15_days = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 15);
                    const lastYear = today.getFullYear() - 1;

                    const defaultLeaveBalance = { casual: 12, sick: 6 };

                    const users = [
                        { id: 'user-1', data: { firstName: 'Srini', lastName: 'A', email: 'srini@ay-technologies.com', password: 'srini@', department: 'hr', role: 'admin', status: 'active', joinDate: getLocalDateString(), dob: '1985-05-20', lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }},
                        { id: 'user-2', data: { firstName: 'Vamsi', lastName: 'B', email: 'vamsi@ay-technologies.com', password: 'vamsi@', department: 'web-developer', role: 'manager', status: 'active', joinDate: getLocalDateString(), dob: '1990-11-03', lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }}, 
                        { id: 'user-3', data: { firstName: 'Kiran', lastName: 'C', email: 'kiran@ay-technologies.com', password: 'kiran@', department: 'web-developer', role: 'employee', status: 'active', joinDate: getLocalDateString(), dob: `${currentYear}-${String(dob_today.getMonth()+1).padStart(2,'0')}-${String(dob_today.getDate()).padStart(2,'0')}`, lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }},
                        { id: 'user-4', data: { firstName: 'Pragnika', lastName: 'D', email: 'pragnika@ay-technologies.com', password: 'pragnika@', department: 'digital-marketing', role: 'employee', status: 'active', joinDate: getLocalDateString(), dob: `${currentYear}-${String(dob_in_5_days.getMonth()+1).padStart(2,'0')}-${String(dob_in_5_days.getDate()).padStart(2,'0')}`, lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }},
                        { id: 'user-5', data: { firstName: 'Hemanth', lastName: 'E', email: 'hemanth@ay-technologies.com', password: 'hemanth@', department: 'developer', role: 'employee', status: 'active', joinDate: getLocalDateString(), dob: `${currentYear}-${String(dob_in_15_days.getMonth()+1).padStart(2,'0')}-${String(dob_in_15_days.getDate()).padStart(2,'0')}`, lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }},
                        { id: 'user-6', data: { firstName: 'Tanisha', lastName: 'F', email: 'tanisha@ay-technologies.com', password: 'tanisha@', department: 'graphic-designer', role: 'employee', status: 'active', joinDate: getLocalDateString(), dob: '1999-01-30', lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }},
                        { id: 'user-7', data: { firstName: 'Kushi', lastName: 'G', email: 'kushi@ay-technologies.com', password: 'kushi@', department: 'content-writer', role: 'employee', status: 'active', joinDate: getLocalDateString(), dob: '1995-08-12', lastBirthdayNotifYear: lastYear, leaveBalances: defaultLeaveBalance }}
                    ];
                    users.forEach(user => batch.set(doc(firestore, 'employees', user.id), user.data));
                    
                    const todayForTask = new Date();
                    const yesterdayForTask = new Date(todayForTask);
                    yesterdayForTask.setDate(todayForTask.getDate() - 1);

                    const tasks = [
                        { id: 'task-1', data: { title: "Complete Q2 Report", description: "Prepare quarterly financial report", assignee: ['user-3'], assignedBy: 'user-1', originalAssigner: 'user-1', deadline: "2024-07-25", priority: "high", status: "assigned", createdAt: todayForTask.toISOString(), reassignmentHistory: [], attachment: null } },
                        { id: 'task-2', data: { title: "Website Redesign Mockup", description: "Complete homepage redesign", assignee: ['user-6'], assignedBy: 'user-2', originalAssigner: 'user-2', deadline: "2024-07-10", priority: "high", status: "completed", completedOn: "2024-07-10", completedBy: "user-6", createdAt: yesterdayForTask.toISOString(), reassignmentHistory: [], attachment: null } }
                    ];
                    tasks.forEach(task => batch.set(doc(firestore, 'tasks', task.id), task.data));

                    await batch.commit();
                    showAlert("Demo data has been reset in Firebase.", "success");
                } catch (error) {
                    console.error("Error resetting database:", error);
                    showAlert("Failed to reset demo data. Check console for errors.", "danger");
                } finally {
                    hideLoader();
                }
            }
        };

        // ==============================================
        // ==== NOTIFICATION LOGIC (UPDATED FOR V9 & EMAIL) ====
        // ==============================================

        async function createNotification(userId, title, message, linkView = 'dashboard', data = {}) {
            try {
                if (!userId) return;
                // 1. Create in-app notification in Firestore
                const notificationData = {
                    userId: userId, title: title, message: message, linkView: linkView,
                    read: false, createdAt: new Date(), ...data
                };
                await db.addDocument('notifications', notificationData);

                // 2. Send email notification
                const recipient = appState.employees.find(emp => emp.id === userId);
                if (recipient && recipient.email) {
                    await sendEmailNotification(recipient.email, recipient.firstName, title, message);
                }

            } catch (error) {
                console.error(`Failed to create notification for user ${userId}:`, error);
            }
        }

        function setupNotificationListener() {
            clearAllListeners(); 
            if (!currentUser) return;

            const q = query(
                collection(firestore, 'notifications'), 
                where('userId', '==', currentUser.id),
                orderBy('createdAt', 'desc'),
                limit(20)
            );

            const unsubscribe = onSnapshot(q, snapshot => {
                const notifications = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderNotifications(notifications);
            }, error => {
                console.error("Error listening for notifications:", error);
            });
            unsubscribeListeners.push(unsubscribe); // Store the listener to unsubscribe later
        }

        function setupRealtimeListeners() {
            clearAllListeners(); // Clear any previous listeners
            if (!currentUser) return;
        
            const collectionsToListen = ['employees', 'tasks', 'leaves', 'appreciations', 'attendance', 'activities', 'learningGoals'];
        
            collectionsToListen.forEach(coll => {
                const q = query(collection(firestore, coll));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const changes = querySnapshot.docChanges();
                    let needsUIRefresh = false;
                    changes.forEach((change) => {
                        const docData = { id: change.doc.id, ...change.doc.data() };
                        const index = appState[coll].findIndex(item => item.id === docData.id);
        
                        if (change.type === "added") {
                            if (index === -1) appState[coll].push(docData);
                            needsUIRefresh = true;
                        }
                        if (change.type === "modified") {
                            if (index > -1) appState[coll][index] = docData;
                            else appState[coll].push(docData); 
                            needsUIRefresh = true;
                        }
                        if (change.type === "removed") {
                            if (index > -1) appState[coll].splice(index, 1);
                             needsUIRefresh = true;
                        }
                    });
        
                    // Only re-render if there were changes
                    if(needsUIRefresh) {
                        loadCurrentView();
                    }
                }, (error) => {
                    console.error(`Error listening to ${coll}: `, error);
                });
                unsubscribeListeners.push(unsubscribe);
            });
            setupNotificationListener(); // Notifications need their own specific listener logic
        }

        function clearAllListeners() {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
        }
        
        function renderNotifications(notifications) {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            const placeholder = document.getElementById('no-notification-placeholder');
            const footer = document.getElementById('notification-footer');
            list.innerHTML = '';
            
            if (notifications.length === 0) {
                placeholder.classList.remove('d-none'); footer.classList.add('d-none'); badge.classList.add('d-none'); return;
            }
            placeholder.classList.add('d-none');
            
            let unreadCount = 0;
            notifications.forEach(notif => {
                if (!notif.read) unreadCount++;
                let timeAgo = 'just now';
                if (notif.createdAt && notif.createdAt.toDate) {
                    const notifDate = notif.createdAt.toDate(); const seconds = Math.floor((new Date() - notifDate) / 1000); let interval = Math.floor(seconds / 31536000);
                    if (interval > 1) { timeAgo = interval + " years ago"; } else { interval = Math.floor(seconds / 2592000); if (interval >= 1) { timeAgo = interval + " month" + (interval > 1 ? "s" : "") + " ago"; } else { interval = Math.floor(seconds / 86400); if (interval >= 1) { timeAgo = interval + " day" + (interval > 1 ? "s" : "") + " ago"; } else { interval = Math.floor(seconds / 3600); if (interval >= 1) { timeAgo = interval + " hour" + (interval > 1 ? "s" : "") + " ago"; } else { interval = Math.floor(seconds / 60); if (interval >= 1) { timeAgo = interval + " minute" + (interval > 1 ? "s" : "") + " ago"; } else { timeAgo = Math.floor(seconds) + " seconds ago"; }}}}}
                }
                const taskIdAttr = notif.taskId ? `data-task-id="${notif.taskId}"` : '';
                list.innerHTML += `<li><a href="#" class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}" data-view="${notif.linkView}" ${taskIdAttr}><div class="fw-bold">${notif.title}</div><div class="message">${notif.message}</div><div class="time mt-1">${timeAgo}</div></a></li>`;
            });
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount; badge.classList.remove('d-none'); footer.classList.remove('d-none');
            } else {
                badge.classList.add('d-none'); footer.classList.add('d-none');
            }
        }
        
        async function handleNotificationClick(e) {
            e.preventDefault();
            const target = e.target.closest('.notification-item');
            if (!target) return;

            const notifId = target.dataset.id;
            const linkView = target.dataset.view;
            const taskId = target.dataset.taskId;

            // Optimistic UI: Mark as read visually immediately
            target.classList.remove('unread');
            await db.updateDocument('notifications', notifId, { read: true });

            const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('notification-bell'));
            if(dropdown) dropdown.hide();

            if(linkView) {
                const viewLink = document.querySelector(`.sidebar-menu a[data-view="${linkView}"]`);
                if(viewLink) {
                    viewLink.click();
                    if (taskId) {
                        setTimeout(() => scrollToTask(taskId), 100);
                    }
                }
            }
        }
        
        function scrollToTask(taskId) {
            const taskElement = document.getElementById(`task-card-${taskId}`);
            if (taskElement) {
                taskElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                taskElement.classList.add('highlight');
                setTimeout(() => {
                    taskElement.classList.remove('highlight');
                }, 2500); // Highlight for 2.5 seconds
            }
        }
        
        async function markAllNotificationsAsRead() {
            showLoader();
            try {
                const q = query(
                    collection(firestore, 'notifications'), 
                    where('userId', '==', currentUser.id),
                    where('read', '==', false)
                );
                const notificationsSnapshot = await getDocs(q);
                if (notificationsSnapshot.empty) return;

                const batch = writeBatch(firestore);
                notificationsSnapshot.docs.forEach(d => batch.update(d.ref, { read: true }));
                await batch.commit();
            } catch (error) {
                console.error("Error marking all notifications as read:", error);
            } finally {
                hideLoader();
            }
        }

        async function checkAndSendBirthdayNotifications() {
            if (!['admin', 'manager'].includes(currentUser.role)) return;
            try {
                const now = new Date(); const currentYear = now.getFullYear();
                const todayMonthDay = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                
                const allEmployees = appState.employees; 
                const birthdaysToday = allEmployees.filter(emp => emp.dob && emp.dob.substring(5) === todayMonthDay && emp.lastBirthdayNotifYear !== currentYear);

                if (birthdaysToday.length === 0) return;

                const recipients = allEmployees.filter(emp => ['admin', 'manager'].includes(emp.role) && emp.status === 'active');
                if(recipients.length === 0) return;

                const batch = writeBatch(firestore);
                for (const birthdayEmployee of birthdaysToday) {
                    const notificationPromises = recipients.map(recipient => 
                        createNotification(recipient.id, " Birthday Today!", `It's ${birthdayEmployee.firstName} ${birthdayEmployee.lastName}'s birthday! Don't forget to wish them.`, 'employees')
                    );
                    await Promise.all(notificationPromises);
                    
                    const empRef = doc(firestore, 'employees', birthdayEmployee.id);
                    batch.update(empRef, { lastBirthdayNotifYear: currentYear });
                }
                await batch.commit();
            } catch (error) {
                console.error("Error checking/sending birthday notifications:", error);
            }
        }

        async function checkAndSendHolidayNotifications() {
            if (currentUser.role !== 'admin') return; // Only admins should send these to avoid duplicates
            const today = new Date();
            const notificationThreshold = 7; // Notify 7 days in advance

            for (const holiday of HOLIDAYS_2025) {
                const holidayDate = new Date(holiday.date + 'T00:00:00');
                const diffDays = Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24));

                if (diffDays > 0 && diffDays <= notificationThreshold) {
                    const notifCheckId = `holiday-${holiday.date}`;
                    const existingNotif = await db.getDocument('app_metadata', notifCheckId);

                    if (!existingNotif) {
                        const title = "Upcoming Holiday";
                        const message = `${holiday.occasion} is on ${holiday.day}, ${holiday.date}.`;
                        
                        const recipients = appState.employees.filter(e => e.status === 'active');
                        const promises = recipients.map(r => createNotification(r.id, title, message, 'dashboard'));
                        await Promise.all(promises);

                        await db.setDocument('app_metadata', notifCheckId, { sentAt: new Date() });
                    }
                }
            }
        }


        // ==============================================
        // ==== APPLICATION LOGIC ====
        // ==============================================

        // ==============================================
        // ==== NEW LOGIN UI ANIMATION FUNCTIONS ========
        // ==============================================
        function createNetwork() {
            const networkContainer = document.getElementById('networkContainer');
            if (!networkContainer) return;
            const nodes = []; const connections = []; const serverIcons = [];
            networkContainer.innerHTML = '';
            const serverCount = 3;
            for (let i = 0; i < serverCount; i++) {
                const server = document.createElement('i');
                server.className = 'server-icon fas fa-server'; server.style.left = `${10 + (i * 40)}%`;
                server.style.top = `${20 + (i * 20)}%`; networkContainer.appendChild(server); serverIcons.push(server);
                setInterval(() => {
                    const pulse = document.createElement('div'); pulse.className = 'network-pulse';
                    pulse.style.left = server.style.left; pulse.style.top = server.style.top; networkContainer.appendChild(pulse);
                    let size = 10;
                    const pulseInterval = setInterval(() => {
                        size += 5; pulse.style.width = `${size}px`; pulse.style.height = `${size}px`; pulse.style.opacity = 1 - (size / 100);
                        if (size > 100) { clearInterval(pulseInterval); pulse.remove(); }
                    }, 30);
                }, 2000 + (i * 1000));
            }
            const nodeCount = 15;
            for (let i = 0; i < nodeCount; i++) {
                const node = document.createElement('div'); node.className = 'network-node';
                node.style.left = `${Math.random() * 100}%`; node.style.top = `${Math.random() * 100}%`; networkContainer.appendChild(node); nodes.push(node);
            }
            // Cannot create connections on initial load as elements have no size yet.
            // A better approach would be to do this after the auth screen is visible.
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoader();
            try {
                // Initialize Bootstrap Modals
                employeeModal = new bootstrap.Modal(document.getElementById('employeeModal')); 
                taskModal = new bootstrap.Modal(document.getElementById('taskModal')); 
                reassignTaskModal = new bootstrap.Modal(document.getElementById('reassignTaskModal'));
                monthlyReportModal = new bootstrap.Modal(document.getElementById('monthlyReportModal')); 
                statDetailModal = new bootstrap.Modal(document.getElementById('statDetailModal'));
                activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
                goalModal = new bootstrap.Modal(document.getElementById('goalModal'));
                aiGoalSuggestionModal = new bootstrap.Modal(document.getElementById('aiGoalSuggestionModal'));
                employeeProfileModal = new bootstrap.Modal(document.getElementById('employeeProfileModal'));

                // New UI functionalities
                const togglePassword = document.querySelector('#togglePassword');
                const password = document.querySelector('#login-password');
                if (togglePassword) {
                    togglePassword.addEventListener('click', function() {
                        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                        password.setAttribute('type', type); this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                    });
                }
                createNetwork(); // Initialize background animation

                await db.init();
                setupEventListeners();
                
                currentUser = db.getCurrentUser();
                
                if (currentUser) {
                    await showDashboard();
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error("Initialization Error:", error); showAlert("Application failed to initialize. Please refresh.", "danger");
            } finally {
                hideLoader();
            }
        });

        function setupEventListeners() {
            DOMElements.loginBtn.addEventListener('click', handleLogin);
            DOMElements.setupLink.addEventListener('click', async (e) => { e.preventDefault(); if (confirm("This will reset all data in Firebase and set up default demo users. Proceed?")) { await db.reset(); } });
            DOMElements.logoutBtn.addEventListener('click', handleLogout);
            DOMElements.addEmployeeBtn.addEventListener('click', openEmployeeModalForAdd);
            DOMElements.saveEmployeeBtn.addEventListener('click', handleSaveEmployee);
            DOMElements.logoUploadInput.addEventListener('change', handleLogoUpload);
            DOMElements.addNewDepartmentBtn.addEventListener('click', handleAddNewDepartment); 
            const sidebar = document.querySelector('.sidebar'); const mainContent = document.querySelector('.main-content');
            document.querySelector('.mobile-menu-btn').addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('active'); });
            mainContent.addEventListener('click', () => { if (sidebar.classList.contains('active')) { sidebar.classList.remove('active'); } });
            DOMElements.viewLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link.id === 'logout-btn') return; if (sidebar.classList.contains('active')) { sidebar.classList.remove('active'); } DOMElements.viewLinks.forEach(l => l.classList.remove('active')); link.classList.add('active'); const viewName = link.dataset.view; DOMElements.viewTitle.textContent = link.textContent.trim(); DOMElements.viewContents.forEach(view => view.classList.add('d-none')); document.getElementById(`${viewName}-view`).classList.remove('d-none'); loadViewData(viewName); }); });
            DOMElements.mainClockBtn.addEventListener('click', toggleClock);
            DOMElements.addTaskBtn.addEventListener('click', openTaskModalForAdd); DOMElements.addTaskBtn2.addEventListener('click', openTaskModalForAdd);
            DOMElements.saveTaskBtn.addEventListener('click', handleSaveTask);
            DOMElements.saveReassignBtn.addEventListener('click', handleReassignTask);
            DOMElements.addAppreciationBtn.addEventListener('click', () => { document.querySelector('[data-view="appreciations"]').click(); });
            DOMElements.appreciationForm.addEventListener('submit', handleSaveAppreciation);
            DOMElements.leaveForm.addEventListener('submit', handleSaveLeave); DOMElements.profileForm.addEventListener('submit', handleSaveProfile); DOMElements.passwordForm.addEventListener('submit', handleChangePassword);
            
            // New event listeners for AI and other features
            DOMElements.addActivityBtn.addEventListener('click', openActivityModalForAdd);
            DOMElements.saveActivityBtn.addEventListener('click', handleSaveActivity);
            DOMElements.addGoalBtn.addEventListener('click', openGoalModalForAdd);
            DOMElements.saveGoalBtn.addEventListener('click', handleSaveGoal);
            DOMElements.generateAppreciationBtn.addEventListener('click', handleGenerateAppreciation);
            DOMElements.generateTaskDescBtn.addEventListener('click', handleGenerateTaskDescription);
            DOMElements.suggestGoalsBtn.addEventListener('click', handleSuggestLearningGoals);
            DOMElements.regenerateGoalsBtn.addEventListener('click', handleSuggestLearningGoals);
            document.getElementById('goal-employee-filter').addEventListener('change', renderLearningGoals);

            // Delegated Event Listeners for Dynamic Content
            document.getElementById('team-tasks-container').addEventListener('click', handleTaskCardClick);
            document.getElementById('user-tasks-container').addEventListener('click', handleTaskCardClick);
            document.getElementById('employees-table').addEventListener('click', handleEmployeeTableClick);
            document.getElementById('pending-approvals-table').addEventListener('click', handleLeaveApprovalClick);
            document.getElementById('notification-list').addEventListener('click', handleNotificationClick);
            document.getElementById('admin-attendance-table-dashboard').addEventListener('click', handleAdminDashboardClick);


            document.getElementById('task-filter').addEventListener('change', renderTeamTasks); document.getElementById('appreciation-filter').addEventListener('change', renderTeamAppreciations);
            document.getElementById('new-password').addEventListener('input', function() { const strength = calculatePasswordStrength(this.value); const strengthBar = document.getElementById('password-strength'); strengthBar.className = 'password-strength'; strengthBar.classList.add('strength-' + Math.min(strength, 4)); });
            document.getElementById('change-photo-btn').addEventListener('click', () => document.getElementById('profile-pic-input').click());
            document.getElementById('profile-pic-input').addEventListener('change', handleProfilePicUpload);
            document.getElementById('attendance-month').addEventListener('change', renderAttendanceRecords); document.getElementById('attendance-year').addEventListener('change', renderAttendanceRecords);
            document.getElementById('report-month').addEventListener('change', renderMonthlyReportForEmployee); document.getElementById('report-year').addEventListener('change', renderMonthlyReportForEmployee);
            document.querySelectorAll('.stat-card').forEach(card => card.addEventListener('click', () => showStatDetails(card.dataset.stat)));
            document.getElementById('mark-all-read-btn').addEventListener('click', (e) => { e.preventDefault(); markAllNotificationsAsRead(); });
            const now = new Date(); document.getElementById('attendance-month').value = now.getMonth(); const yearSelect = document.getElementById('attendance-year'); yearSelect.innerHTML = ''; const currentYear = now.getFullYear();
            for (let y = currentYear; y >= currentYear - 3; y--) { const option = document.createElement('option'); option.value = y; option.text = y; yearSelect.add(option); }
            yearSelect.value = currentYear; updateLiveClock(); setInterval(updateLiveClock, 1000);

            // Delegated event listener for viewing profiles
            DOMElements.dashboard.addEventListener('click', function(e) {
                const profileLink = e.target.closest('.view-profile-link');
                const profileBtn = e.target.closest('.view-profile-btn');

                if (profileLink) {
                    e.preventDefault();
                    const employeeId = profileLink.dataset.id;
                    if (employeeId) {
                        openEmployeeProfileModal(employeeId);
                    }
                } else if (profileBtn) {
                    const employeeId = profileBtn.dataset.id;
                    if (employeeId) {
                        openEmployeeProfileModal(employeeId);
                    }
                }
            });
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value.toLowerCase();
            const password = document.getElementById('login-password').value;
            const loginBtn = DOMElements.loginBtn;
            const errorDiv = document.getElementById('login-error');

            if (!email || !password) { showAlert('Email and password are required.', 'warning'); return; }
            
            setButtonLoading(loginBtn, true);
            errorDiv.classList.add('d-none');
            
            try {
                const q = query(
                    collection(firestore, 'employees'), 
                    where('email', '==', email), 
                    where('password', '==', password),
                    limit(1)
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) { 
                    errorDiv.textContent = 'Invalid credentials. Please try again.';
                    errorDiv.classList.remove('d-none');
                    errorDiv.classList.add('animate__animated', 'animate__shakeX');
                    setTimeout(() => errorDiv.classList.remove('animate__shakeX'), 1000);
                    return; 
                }

                const userDoc = snapshot.docs[0];
                const foundUser = { id: userDoc.id, ...userDoc.data() };

                if (foundUser.status === 'active') {
                    currentUser = foundUser; db.setCurrentUser(currentUser); await showDashboard();
                } else { 
                    errorDiv.textContent = 'Your account is inactive.';
                    errorDiv.classList.remove('d-none');
                }
            } catch (error) {
                console.error("Login Error:", error); 
                errorDiv.textContent = 'An error occurred. Please try again.';
                errorDiv.classList.remove('d-none');
            } finally { 
                setButtonLoading(loginBtn, false);
            }
        }
        
        async function showDashboard() { 
            showLoader();
            // Initial fetch of all data
            const [employees, tasks, leaves, appreciations, attendance, activities, learningGoals] = await Promise.all([
                db.getCollection('employees'),
                db.getCollection('tasks'),
                db.getCollection('leaves'),
                db.getCollection('appreciations'),
                db.getCollection('attendance'),
                db.getCollection('activities'),
                db.getCollection('learningGoals')
            ]);
            appState = { employees, tasks, leaves, appreciations, attendance, activities, learningGoals };

            await loadAndPopulateDepartments();

            try {
                const logoDoc = await db.getDocument('app_metadata', 'logo');
                if (logoDoc && logoDoc.base64) {
                    DOMElements.sidebarLogo.src = logoDoc.base64;
                    DOMElements.sidebarLogo.style.display = 'inline';
                } else {
                    DOMElements.sidebarLogo.style.display = 'none';
                }
            } catch (error) {
                console.error("Failed to load company logo:", error);
                DOMElements.sidebarLogo.style.display = 'none';
            }

            DOMElements.authScreen.classList.add('d-none'); DOMElements.dashboard.classList.remove('d-none');
            updateUIForUserRole();
            setupRealtimeListeners(); // This will setup all listeners including notifications
            document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
            const dashboardLink = document.querySelector('[data-view="dashboard"]');
            dashboardLink.classList.add('active');
            DOMElements.viewTitle.textContent = dashboardLink.textContent.trim();
            DOMElements.viewContents.forEach(view => view.classList.add('d-none'));
            document.getElementById('dashboard-view').classList.remove('d-none');
            await updateClockWidgetState();
            loadViewData('dashboard');
            hideLoader();
        }

        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            showLoader();
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64String = e.target.result;
                try {
                    await db.setDocument('app_metadata', 'logo', { base64: base64String });
                    DOMElements.sidebarLogo.src = base64String;
                    DOMElements.sidebarLogo.style.display = 'inline';
                    showAlert('Logo updated successfully!', 'success');
                } catch (error) {
                    console.error("Logo upload error:", error);
                    showAlert('Failed to update the logo.', 'danger');
                } finally {
                    hideLoader();
                }
            };
            reader.readAsDataURL(file);
        }

        function updateLiveClock() {
            const now = new Date();
            if (DOMElements.liveClock) DOMElements.liveClock.textContent = now.toLocaleTimeString('en-US');
            if(DOMElements.liveDate) DOMElements.liveDate.textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        async function updateClockWidgetState() {
            if (workTimerInterval) clearInterval(workTimerInterval);
            if (!DOMElements.mainClockBtn || !currentUser) return;
            
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=Sun, 6=Sat
            const todayStr = getLocalDateString(today);

            // Get the most up-to-date record from the local state
            const todaysRecord = appState.attendance.find(a => a.employeeId === currentUser.id && a.date === todayStr);
            const onLeaveRecord = appState.leaves.find(l => 
                l.employeeId === currentUser.id && 
                l.status === 'approved' && 
                todayStr >= l.startDate && 
                todayStr <= l.endDate
            );

            const btn = DOMElements.mainClockBtn;
            const statusText = DOMElements.clockStatusText;
            const details = DOMElements.clockDetails;
            const timerDisplay = DOMElements.workTimerDisplay;
            const btnIcon = btn.querySelector('i');
            const btnText = btn.querySelector('.btn-text');
            
            // Reset to default state first
            btn.disabled = false;
            btn.classList.remove("clocked-in", "completed");
            statusText.classList.remove("text-danger");
            details.classList.add('hidden'); 
            timerDisplay.classList.add('hidden'); 

            if (onLeaveRecord) {
                const leaveType = onLeaveRecord.type;
                btn.classList.add("completed"); 
                btnIcon.className = leaveType === 'wfh' ? 'fas fa-laptop-house' : 'fas fa-plane-departure';
                btnText.textContent = LEAVE_TYPES[leaveType] || "On Leave"; 
                statusText.textContent = `You are on approved ${LEAVE_TYPES[leaveType] || 'leave'} today.`; 
                btn.disabled = true;

            } else if (todaysRecord && todaysRecord.clockIn && !todaysRecord.clockOut) {
                btn.classList.add("clocked-in"); 
                btnIcon.className = 'fas fa-stop'; 
                btnText.textContent = "Clock Out"; 
                statusText.textContent = "Your shift is in progress."; 
                details.classList.remove('hidden'); 
                timerDisplay.classList.remove('hidden');
                DOMElements.clockInTime.textContent = new Date(`${todayStr}T${todaysRecord.clockIn}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit'});
                const clockInTime = new Date(`${todayStr}T${todaysRecord.clockIn}`);
                workTimerInterval = setInterval(() => {
                    const diff = new Date() - clockInTime; const hours = Math.floor(diff / 3600000); const minutes = Math.floor((diff % 3600000) / 60000); const seconds = Math.floor((diff % 60000) / 1000);
                    DOMElements.workDuration.textContent = `${hours}h ${minutes}m ${seconds}s`;
                }, 1000);

            } else if (todaysRecord && todaysRecord.clockOut) {
                btn.classList.add("completed"); 
                btnIcon.className = 'fas fa-check'; 
                btnText.textContent = "Completed"; 
                statusText.textContent = "You have completed your work for today."; 
                btn.disabled = true; 
                details.classList.remove('hidden');
                DOMElements.clockInTime.textContent = new Date(`${todayStr}T${todaysRecord.clockIn}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit'});

            } else if (dayOfWeek === 0 || dayOfWeek === 6) {
                btn.classList.remove("completed");
                btnIcon.className = 'fas fa-bed'; 
                btnText.textContent = "Week Off"; 
                statusText.textContent = "Today is a week-off. Clock in if you need to work."; 
                btn.disabled = false;

            } else {
                btnIcon.className = 'fas fa-play'; 
                btnText.textContent = "Clock In"; 
                statusText.textContent = "You are ready to start your day."; 
                details.classList.add('hidden'); 
                DOMElements.workDuration.textContent = '0h 0m 0s';
            }
        }
        
        async function toggleClock() {
            setButtonLoading(DOMElements.mainClockBtn, true);
            try {
                const todayStr = getLocalDateString();
                const currentTimeStr = new Date().toTimeString().substring(0, 8);
                const todaysRecord = appState.attendance.find(a => a.employeeId === currentUser.id && a.date === todayStr);

                if (todaysRecord && todaysRecord.clockIn && !todaysRecord.clockOut) {
                    if (workTimerInterval) clearInterval(workTimerInterval);
                    await db.updateDocument('attendance', todaysRecord.id, { clockOut: currentTimeStr });
                    
                    // --- OPTIMISTIC UI: Update local state ---
                    todaysRecord.clockOut = currentTimeStr;
                    showAlert(`Clocked out successfully.`, "success");

                } else if (!todaysRecord) {
                    const newRecord = { employeeId: currentUser.id, date: todayStr, clockIn: currentTimeStr, clockOut: null, status: "present" };
                    const docRef = await db.addDocument('attendance', newRecord);

                    // --- OPTIMISTIC UI: Update local state ---
                    appState.attendance.push({ id: docRef.id, ...newRecord });
                    showAlert("Clocked in successfully!", "success");
                } else {
                    showAlert("You have already completed your work for today.", "info");
                }
                
                // --- Re-render the widget with the new local state ---
                await updateClockWidgetState();
            } catch (error) {
                console.error("Clocking Error:", error);
                showAlert("An error occurred. Please try again.", "danger");
            } finally {
                setButtonLoading(DOMElements.mainClockBtn, false);
            }
        }
        
        function loadViewData(viewName) {
            try {
                switch (viewName) {
                    case 'dashboard': 
                        const employeeWidget = document.getElementById('employee-status-widget');
                        const adminWidget = document.getElementById('admin-attendance-widget');
                        if (currentUser.role === 'admin') {
                            employeeWidget.classList.add('d-none'); adminWidget.classList.remove('d-none');
                            renderAdminDashboardAttendance();
                        } else {
                            employeeWidget.classList.remove('d-none'); adminWidget.classList.add('d-none');
                            renderEmployeeStatus();
                        }
                        renderDashboardStats(); 
                        renderUserTasks(); 
                        renderRecentAppreciations();
                        renderUpcomingBirthdays();
                        renderUpcomingHolidays();
                        renderDashboardMarquee();
                        checkAndSendBirthdayNotifications();
                        checkAndSendHolidayNotifications();
                        break;
                    case 'attendance': 
                        renderAttendanceRecords(); 
                        renderAttendanceMarquee();
                        break;
                    case 'leave': 
                        renderLeaveRequests(); 
                        renderPendingApprovals();
                        renderLeaveBalances();
                        break;
                    case 'tasks': 
                        renderTeamTasks();
                        renderTasksMarquee();
                        break;
                    case 'appreciations':
                        const formCol = document.getElementById('appreciation-form-col'); const listCol = document.getElementById('appreciation-list-col');
                        const mineFilterOption = document.getElementById('appreciation-filter-mine'); const allFilterOption = document.querySelector('#appreciation-filter option[value="all"]');
                        if (['admin', 'manager'].includes(currentUser.role)) {
                            formCol.classList.remove('d-none'); listCol.classList.remove('col-md-12'); listCol.classList.add('col-md-6'); mineFilterOption.textContent = 'Given By Me'; allFilterOption.textContent = 'All Appreciations';
                        } else {
                            formCol.classList.add('d-none'); listCol.classList.remove('col-md-6'); listCol.classList.add('col-md-12'); mineFilterOption.textContent = 'Received By Me'; allFilterOption.textContent = 'All Public';
                        }
                        renderAppreciationFormData(); renderTeamAppreciations();
                        break;
                    case 'activities': 
                        renderActivities(); 
                        renderActivitiesMarquee();
                        break;
                    case 'learning-goals': 
                        renderLearningGoals(); 
                        renderGoalsMarquee();
                        break;
                    case 'analytics': renderAnalyticsCharts(); break;
                    case 'employees': if (currentUser.role === 'admin') renderEmployees(); break;
                    case 'profile': renderProfileData(); break;
                }
            } catch (error) {
                console.error(`Error loading view ${viewName}:`, error);
                showAlert(`Failed to render data for ${viewName}.`, "danger");
            }
        }

        /**
         * Gathers data for and renders the dynamic marquee on the dashboard.
         */
        function renderDashboardMarquee() {
            const marquee = document.getElementById('dashboard-marquee');
            if (!marquee) return;

            let updateMessages = [`Welcome back, ${currentUser.firstName}! Hope you have a productive day.`];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentYear = today.getFullYear();
            const monthDayFormatter = new Intl.DateTimeFormat('en-US', { month: 'long', day: 'numeric' });

            // 1. Get Upcoming Birthdays (next 7 days)
            const upcomingBirthdays = appState.employees
                .filter(e => e.status === 'active' && e.dob)
                .map(employee => {
                    const [birthYear, birthMonth, birthDay] = employee.dob.split('-').map(Number);
                    let nextBirthday = new Date(currentYear, birthMonth - 1, birthDay);
                    if (nextBirthday < today) nextBirthday.setFullYear(currentYear + 1);
                    const diffDays = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                    return { ...employee, nextBirthday, diffDays };
                })
                .filter(e => e.diffDays >= 0 && e.diffDays <= 7)
                .sort((a, b) => a.diffDays - b.diffDays);
            
            upcomingBirthdays.forEach(emp => {
                const dateString = (emp.diffDays === 0) ? "Today" : `on ${monthDayFormatter.format(emp.nextBirthday)}`;
                updateMessages.push(` Wish ${emp.firstName} ${emp.lastName} a happy birthday ${dateString}!`);
            });

            // 2. Get Upcoming Holidays (next 14 days)
            const upcomingHolidays = HOLIDAYS_2025
                .filter(h => {
                    const holidayDate = new Date(h.date + 'T00:00:00');
                    const diffDays = Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24));
                    return diffDays >= 0 && diffDays <= 14;
                })
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            upcomingHolidays.forEach(holiday => {
                updateMessages.push(` Upcoming Holiday: ${holiday.occasion} is on ${holiday.day}, ${monthDayFormatter.format(new Date(holiday.date + 'T00:00:00'))}.`);
            });

            // 3. Get Recent Task Assignments (last 48 hours)
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);

            const recentTasks = appState.tasks
                .filter(t => new Date(t.createdAt) > twoDaysAgo)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 3); // Limit to 3 recent tasks

            recentTasks.forEach(task => {
                const assigneeNames = (Array.isArray(task.assignee) ? task.assignee : [task.assignee])
                    .map(id => appState.employees.find(e => e.id === id)?.firstName || 'N/A')
                    .join(', ');
                updateMessages.push(` New Task Assigned: "${task.title}" to ${assigneeNames}.`);
            });
            
            // 4. Render the final string
            if (updateMessages.length > 1) {
                marquee.innerHTML = updateMessages.join(" &nbsp; &nbsp;  &nbsp; &nbsp; ");
            } else {
                marquee.innerHTML = updateMessages[0]; // Just the welcome message
            }
        }

        // NEW MARQUEE FUNCTION: For the Attendance View
        function renderAttendanceMarquee() {
            const marquee = document.getElementById('attendance-marquee');
            if (!marquee) return;
            let updateMessages = [];
            const dailyStatuses = getDailyStatusesFromCache();
            const presentCount = dailyStatuses.filter(s => s.status === 'present').length;
            const onLeaveCount = dailyStatuses.filter(s => s.status !== 'present' && s.status !== 'weekend' && s.status !== 'absent').length;

            updateMessages.push(`Today's Status: ${presentCount} employee(s) are present.`);
            if (onLeaveCount > 0) {
                updateMessages.push(`${onLeaveCount} employee(s) are on leave or working from home.`);
            }

            const myStatus = dailyStatuses.find(s => s.employee.id === currentUser.id);
            if(myStatus) {
                if (myStatus.status === 'present' && myStatus.record && !myStatus.record.clockOut) {
                    updateMessages.push("Reminder: Don't forget to clock out at the end of your shift!");
                } else if (myStatus.status === 'absent') {
                    updateMessages.push("You haven't clocked in yet today. Please clock in to record your attendance.");
                }
            }
            
            marquee.innerHTML = updateMessages.join(" &nbsp; &nbsp;  &nbsp; &nbsp; ");
        }

        // NEW MARQUEE FUNCTION: For the Tasks View
        function renderTasksMarquee() {
            const marquee = document.getElementById('tasks-marquee');
            if (!marquee) return;
            let updateMessages = [];
            const todayStr = getLocalDateString();

            const overdueTasks = appState.tasks.filter(t => t.status !== 'completed' && t.deadline < todayStr).length;
            const highPriorityTasks = appState.tasks.filter(t => t.status !== 'completed' && t.priority === 'high').length;
            const completedToday = appState.tasks.filter(t => t.status === 'completed' && t.completedOn === todayStr).length;

            updateMessages.push(`Team Task Summary: ${appState.tasks.filter(t=>t.status !== 'completed').length} active tasks.`);
            if (overdueTasks > 0) {
                updateMessages.push(` There are ${overdueTasks} overdue task(s).`);
            }
            if (highPriorityTasks > 0) {
                updateMessages.push(` ${highPriorityTasks} high-priority task(s) require attention.`);
            }
            if (completedToday > 0) {
                updateMessages.push(` Great work! ${completedToday} task(s) have been completed today.`);
            } else {
                updateMessages.push("Let's get some tasks completed today!");
            }
            
            marquee.innerHTML = updateMessages.join(" &nbsp; &nbsp;  &nbsp; &nbsp; ");
        }
        
        // NEW MARQUEE FUNCTION: For the Activities View
        function renderActivitiesMarquee() {
            const marquee = document.getElementById('activities-marquee');
            if (!marquee) return;
            let updateMessages = ["Track team development and training sessions here."];
            const sortedActivities = [...appState.activities].sort((a,b) => new Date(b.date) - new Date(a.date));

            if (sortedActivities.length > 0) {
                const latestActivity = sortedActivities[0];
                updateMessages.push(`Latest Activity: "${latestActivity.name}" was logged on ${latestActivity.date}.`);
            }
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const activitiesThisMonth = appState.activities.filter(a => {
                const actDate = new Date(a.date);
                return actDate.getMonth() === thisMonth && actDate.getFullYear() === thisYear;
            }).length;

            updateMessages.push(`A total of ${activitiesThisMonth} activities have been logged this month.`);
            updateMessages.push("Log new activities to keep track of team growth.");

            marquee.innerHTML = updateMessages.join(" &nbsp; &nbsp;  &nbsp; &nbsp; ");
        }

        // NEW MARQUEE FUNCTION: For the Learning Goals View
        function renderGoalsMarquee() {
            const marquee = document.getElementById('goals-marquee');
            if (!marquee) return;
            let updateMessages = [];

            const inProgressGoals = appState.learningGoals.filter(g => g.status === 'in-progress').length;
            const completedGoals = appState.learningGoals.filter(g => g.status === 'completed').length;

            updateMessages.push(`There are currently ${inProgressGoals} goal(s) in progress across the team.`);
            updateMessages.push(`A total of ${completedGoals} goal(s) have been completed so far. Keep up the great work!`);
            if (['admin', 'manager'].includes(currentUser.role)) {
                updateMessages.push("Use the AI Goal Suggester to help your team set meaningful objectives.");
            } else {
                updateMessages.push("Remember to update the status of your goals as you make progress.");
            }
            updateMessages.push("Continuous learning is the key to success.");

            marquee.innerHTML = updateMessages.join(" &nbsp; &nbsp;  &nbsp; &nbsp; ");
        }


        async function handleGenerateAppreciation() {
            const employeeSelect = document.getElementById('appreciation-employee');
            const taskSelect = document.getElementById('appreciation-task');
            const noteTextarea = document.getElementById('appreciation-note');
            const generateBtn = DOMElements.generateAppreciationBtn;

            const employeeId = employeeSelect.value;
            const taskId = taskSelect.value;

            if (!employeeId) {
                showAlert("Please select an employee first.", "warning");
                return;
            }

            const employee = appState.employees.find(e => e.id === employeeId);
            const task = taskId ? appState.tasks.find(t => t.id === taskId) : null;

            let prompt = `Write a short (2-3 sentences), professional, and encouraging appreciation message for an employee named ${employee.firstName}.`;
            if (task) {
                prompt += ` The appreciation is specifically for their excellent work on completing the task: "${task.title}".`;
            }
            prompt += ` The message should be positive and motivating. Do not use hashtags or asterisks. Sign it from the manager.`;

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...`;
            
            const aiResponse = await callGemini(prompt);
            
            if (aiResponse) {
                noteTextarea.value = aiResponse;
                showAlert("AI-generated message has been populated.", "success");
            }

            generateBtn.disabled = false;
            generateBtn.innerHTML = `<i class="fas fa-magic me-1"></i> Generate with AI`;
        }

        async function handleGenerateTaskDescription() {
            const titleInput = document.getElementById('task-title');
            const descriptionTextarea = document.getElementById('task-description');
            const generateBtn = DOMElements.generateTaskDescBtn;
            
            const title = titleInput.value;
            if (!title) {
                showAlert("Please enter a Task Title first.", "warning");
                return;
            }

            const prompt = `Based on the task title "${title}", write a detailed and professional task description for an employee. Use bullet points to outline the key objectives and expected deliverables. Keep it concise and clear. Do not use hashtags or asterisks.`;

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...`;

            const aiResponse = await callGemini(prompt);

            if (aiResponse) {
                descriptionTextarea.value = aiResponse;
                showAlert("AI-generated description has been populated.", "success");
            }

            generateBtn.disabled = false;
            generateBtn.innerHTML = `<i class="fas fa-magic me-1"></i> Generate with AI`;
        }

        async function handleSuggestLearningGoals() {
            const isManagerOrAdmin = ['admin', 'manager'].includes(currentUser.role);
            const employeeFilter = document.getElementById('goal-employee-filter');
            const container = document.getElementById('ai-goal-suggestions-container');
            const employeeNameSpan = document.getElementById('ai-goal-employee-name');

            let targetEmployee;

            if (isManagerOrAdmin && employeeFilter.value !== 'all') {
                targetEmployee = appState.employees.find(e => e.id === employeeFilter.value);
            } else {
                targetEmployee = currentUser;
            }

            if (!targetEmployee) {
                showAlert("Please select a specific employee from the filter to get suggestions.", "warning");
                return;
            }

            aiGoalSuggestionModal.show();
            container.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            employeeNameSpan.textContent = `${targetEmployee.firstName} ${targetEmployee.lastName}`;

            const departmentName = allDepartments.find(d => d.id === targetEmployee.department)?.name || targetEmployee.department;
            
            const prompt = `You are a career development coach. Suggest 4 actionable and specific learning goals for an employee.
            Employee Details:
            - Role: ${targetEmployee.role}
            - Department: ${departmentName}

            Instructions:
            - The goals should be relevant to their role and department.
            - Each goal should be a single, complete sentence.
            - Provide ONLY the list of goals. Do not add any introductory or concluding text.
            - Format the output as a numbered list (e.g., "1. Goal one.\\n2. Goal two.").`;

            const aiResponse = await callGemini(prompt);

            if (aiResponse) {
                const goals = aiResponse.split('\n').filter(line => line.trim() !== '').map(line => line.replace(/^\d+\.\s*/, ''));
                
                container.innerHTML = '';
                goals.forEach(goalText => {
                    const goalElement = document.createElement('a');
                    goalElement.href = '#';
                    goalElement.className = 'list-group-item list-group-item-action';
                    goalElement.textContent = goalText;
                    goalElement.onclick = (e) => {
                        e.preventDefault();
                        aiGoalSuggestionModal.hide();
                        openGoalModalForAdd();
                        setTimeout(() => {
                            document.getElementById('goal-employee').value = targetEmployee.id;
                            document.getElementById('goal-description').value = goalText;
                        }, 500);
                    };
                    container.appendChild(goalElement);
                });
            } else {
                container.innerHTML = `<div class="list-group-item text-danger">Failed to generate suggestions. Please try again.</div>`;
            }
        }

        async function loadAndPopulateDepartments() {
            const defaultDepartments = [
                { id: 'hr', name: 'HR' }, { id: 'web-developer', name: 'Web Developer' },
                { id: 'digital-marketing', name: 'Digital Marketing' }, { id: 'graphic-designer', name: 'Graphic Designer' },
                { id: 'developer', name: 'Developer' }, { id: 'content-writer', name: 'Content Writer' }
            ];

            try {
                const dynamicDepartments = await db.getCollection('departments');
                const combined = [...defaultDepartments, ...dynamicDepartments];
                allDepartments = Array.from(new Map(combined.map(item => [item.id, item])).values())
                                      .sort((a, b) => a.name.localeCompare(b.name));
            } catch (error) {
                console.error("Error loading departments:", error);
                allDepartments = defaultDepartments.sort((a, b) => a.name.localeCompare(b.name));
            } finally {
                populateDepartmentDropdown(document.getElementById('employee-department'));
                populateDepartmentDropdown(document.getElementById('profile-department'));
            }
        }

        function populateDepartmentDropdown(selectElement) {
            if (!selectElement) return;
            const currentValue = selectElement.value;
            const firstOption = selectElement.options[0]?.cloneNode(true);
            selectElement.innerHTML = '';
            if (firstOption && (firstOption.value === "" || firstOption.value === null)) {
                selectElement.appendChild(firstOption);
            }
            allDepartments.forEach(dept => selectElement.add(new Option(dept.name, dept.id)));
            selectElement.value = currentValue;
        }

        async function handleAddNewDepartment() {
            const departmentName = prompt("Please enter the new department name:");
            if (departmentName && departmentName.trim() !== '') {
                const name = departmentName.trim();
                const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                if (!id) { showAlert("Invalid department name.", 'warning'); return; }
                if (allDepartments.some(dept => dept.id.toLowerCase() === id.toLowerCase())) {
                    showAlert(`Department "${name}" already exists.`, 'warning'); return;
                }
                showLoader();
                try {
                    await db.setDocument('departments', id, { name: name });
                    showAlert(`Department "${name}" added successfully.`, 'success');
                    // --- OPTIMISTIC UI: Update local state and re-render ---
                    allDepartments.push({id, name});
                    allDepartments.sort((a, b) => a.name.localeCompare(b.name));
                    populateDepartmentDropdown(document.getElementById('employee-department'));
                    populateDepartmentDropdown(document.getElementById('profile-department'));
                    document.getElementById('employee-department').value = id;
                } catch (error) {
                    console.error("Error adding new department:", error);
                    showAlert("Failed to add new department.", "danger");
                } finally { hideLoader(); }
            }
        }

        function renderUpcomingHolidays() {
            const container = document.getElementById('upcoming-holidays-container');
            if (!container) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcoming = HOLIDAYS_2025.filter(h => new Date(h.date + 'T00:00:00') >= today).slice(0, 4);

            if (upcoming.length === 0) {
                container.innerHTML = `<div class="text-center p-3 text-muted">No more holidays for this year.</div>`;
                return;
            }

            let html = '';
            const monthFormatter = new Intl.DateTimeFormat('en-US', { month: 'short' });
            upcoming.forEach(holiday => {
                const holidayDate = new Date(holiday.date + 'T00:00:00');
                const diffDays = Math.ceil((holidayDate - today) / (1000 * 60 * 60 * 24));
                let daysAwayText = diffDays === 0 ? 'Today!' : diffDays === 1 ? 'Tomorrow' : `in ${diffDays} days`;

                html += `
                    <div class="birthday-card">
                        <div class="employee-avatar d-flex align-items-center justify-content-center" style="background-color: var(--success); width: 40px; height: 40px;">
                            <i class="fas fa-gifts text-white"></i>
                        </div>
                        <div class="employee-info">
                            <h6 class="mb-0" style="font-size: 0.9rem;">${holiday.occasion}</h6>
                            <small class="text-muted">${holiday.day}</small>
                        </div>
                        <div class="text-end" style="min-width: 90px;">
                            <div class="birthday-date">
                                <div class="day">${holidayDate.getDate()}</div>
                                <div class="month">${monthFormatter.format(holidayDate)}</div>
                            </div>
                            <small class="text-muted">${daysAwayText}</small>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function renderUpcomingBirthdays() {
            const container = document.getElementById('upcoming-birthdays-container');
            if (!container) return;
            const employees = appState.employees.filter(e => e.status === 'active' && e.dob);
            if (employees.length === 0) { container.innerHTML = `<div class="text-center p-3 text-muted">No employee birthdays found.</div>`; return; }
            
            const today = new Date(); today.setHours(0, 0, 0, 0); const currentYear = today.getFullYear(); const upcomingPeriodDays = 30;
            const upcomingBirthdays = employees.map(employee => {
                const [birthYear, birthMonth, birthDay] = employee.dob.split('-').map(Number);
                let nextBirthday = new Date(currentYear, birthMonth - 1, birthDay); nextBirthday.setHours(0,0,0,0);
                if (nextBirthday < today) nextBirthday.setFullYear(currentYear + 1);
                const diffDays = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
                return { ...employee, nextBirthday, diffDays, age: nextBirthday.getFullYear() - birthYear };
            }).filter(e => e.diffDays >= 0 && e.diffDays <= upcomingPeriodDays).sort((a, b) => a.diffDays - b.diffDays);
            
            if (upcomingBirthdays.length === 0) { container.innerHTML = `<div class="text-center p-3 text-muted">No birthdays in the next ${upcomingPeriodDays} days.</div>`; return; }
            
            let html = ''; const monthFormatter = new Intl.DateTimeFormat('en-US', { month: 'short' });
            upcomingBirthdays.forEach(employee => {
                const avatarSrc = employee.profilePic || `https://ui-avatars.com/api/?name=${employee.firstName}+${employee.lastName}&background=4361ee&color=fff&size=50`;
                let dateInfoHtml = (employee.diffDays === 0) ? `<span class="badge status-badge birthday-today-badge">Today! <i class="fas fa-gift ms-1"></i></span>` : `<div class="birthday-date"><div class="day">${employee.nextBirthday.getDate()}</div><div class="month">${monthFormatter.format(employee.nextBirthday)}</div></div>`;
                html += `<div class="birthday-card"><img src="${avatarSrc}" class="employee-avatar" alt="${employee.firstName}" style="width: 40px; height: 40px;" loading="lazy"><div class="employee-info"><h6 class="mb-0" style="font-size: 0.9rem;">${employee.firstName} ${employee.lastName}</h6><small class="text-muted">Turns ${employee.age}</small></div>${dateInfoHtml}</div>`;
            });
            container.innerHTML = html;
        }

        function getDailyStatusesFromCache() {
            const todayStr = getLocalDateString(new Date());
            const dayOfWeek = new Date().getDay();
            const { employees, attendance, leaves } = appState;
            const activeEmployees = employees.filter(e => e.status === 'active');
            
            return activeEmployees.map(emp => {
                const attendanceRecord = attendance.find(a => a.employeeId === emp.id && a.date === todayStr);
                if (attendanceRecord?.clockIn) {
                    return { employee: emp, status: 'present', record: attendanceRecord };
                }

                const leaveRecord = leaves.find(l => 
                    l.employeeId === emp.id && l.status === 'approved' && todayStr >= l.startDate && todayStr <= l.endDate
                );
                if (leaveRecord) {
                    return { employee: emp, status: leaveRecord.type, record: leaveRecord };
                }

                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    return { employee: emp, status: 'weekend', record: null };
                }

                return { employee: emp, status: 'absent', record: null };
            });
        }

        function showStatDetails(statType) {
            const dailyStatuses = getDailyStatusesFromCache();
            let employeeList = []; let modalTitle = '';
            
            const nonWfhLeaveKeys = ALL_LEAVE_KEYS.filter(k => k !== 'wfh');

            switch(statType) {
                case 'total': 
                    employeeList = appState.employees.filter(e => e.status === 'active'); 
                    modalTitle = 'Total Active Employees'; 
                    break;
                case 'present': 
                    employeeList = dailyStatuses.filter(s => s.status === 'present').map(s => s.employee); 
                    modalTitle = 'Employees Present Today'; 
                    break;
                case 'leave': 
                    employeeList = dailyStatuses.filter(s => nonWfhLeaveKeys.includes(s.status)).map(s => s.employee); 
                    modalTitle = 'Employees On Leave Today'; 
                    break;
                case 'wfh': 
                    employeeList = dailyStatuses.filter(s => s.status === 'wfh').map(s => s.employee); 
                    modalTitle = 'Employees Working Remotely Today'; 
                    break;
            }

            const modalBody = document.getElementById('statDetailModalBody'); modalBody.innerHTML = '';
            if (employeeList.length > 0) {
                employeeList.forEach(employee => {
                    const avatarSrc = employee.profilePic || `https://ui-avatars.com/api/?name=${employee.firstName}+${employee.lastName}&background=4361ee&color=fff&size=50`;
                    const deptName = allDepartments.find(d => d.id === employee.department)?.name || employee.department.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    modalBody.innerHTML += `<div class="employee-card"><img src="${avatarSrc}" class="employee-avatar" alt="${employee.firstName}" loading="lazy"><div class="employee-info"><h6 class="mb-0">${employee.firstName} ${employee.lastName}</h6><small class="text-muted">${deptName}</small></div></div>`;
                });
            } else { modalBody.innerHTML = `<div class="text-center p-4 text-muted">No employees in this category.</div>`; }
            document.getElementById('statDetailModalTitle').textContent = modalTitle;
            statDetailModal.show();
        }
        
        function renderAdminDashboardAttendance() {
            const tableBody = document.getElementById('admin-attendance-table-dashboard'); if (!tableBody) return;
            tableBody.innerHTML = '';
            const dailyStatuses = getDailyStatusesFromCache().sort((a,b) => a.employee.firstName.localeCompare(b.employee.firstName));

            if (dailyStatuses.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-muted">No active users found.</td></tr>`; return; }
            
            dailyStatuses.forEach(({ employee, status, record }) => {
                let statusText = 'Absent', statusClass = 'danger', timeInfo = '--';

                switch(status) {
                    case 'present':
                        statusText = 'Present'; statusClass = 'success';
                        if (record) {
                            const clockInTime = new Date(`1970-01-01T${record.clockIn}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit'});
                            timeInfo = record.clockOut ? `${clockInTime} - ${new Date(`1970-01-01T${record.clockOut}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit'})}` : `${clockInTime} - <span class="text-muted">Now</span>`;
                        }
                        break;
                    case 'wfh': statusText = 'WFH'; statusClass = 'warning'; break;
                    case 'weekend': statusText = 'Weekend'; statusClass = 'secondary'; break;
                    case 'absent': statusText = 'Absent'; statusClass = 'danger'; break;
                    default: statusText = LEAVE_TYPES[status] || 'On Leave'; statusClass = 'info'; break;
                }

                const avatarSrc = employee.profilePic || `https://ui-avatars.com/api/?name=${employee.firstName}+${employee.lastName}&background=4361ee&color=fff&size=50`;
                const employeeNameHtml = `<a href="#" class="text-dark text-decoration-none view-profile-link" data-id="${employee.id}">${employee.firstName} ${employee.lastName}</a>`;
                
                const tr = document.createElement('tr');
                tr.classList.add('align-middle');
                tr.innerHTML = `<td><div class="d-flex align-items-center"><img src="${avatarSrc}" class="employee-avatar me-2" style="width: 35px; height: 35px; font-size: 1rem;" alt="${employee.firstName}" loading="lazy"><div><h6 class="mb-0" style="font-size: 0.9rem;">${employeeNameHtml}</h6><small class="text-muted">${employee.role.charAt(0).toUpperCase() + employee.role.slice(1)}</small></div></div></td><td><span class="badge bg-${statusClass}">${statusText}</span></td><td style="font-size: 0.85rem;">${timeInfo}</td><td><button class="btn btn-sm btn-outline-info view-report-btn" data-id="${employee.id}" title="View Monthly Report"><i class="fas fa-calendar-alt"></i></button></td></tr>`;
                tableBody.appendChild(tr);
            });
        }

        async function openMonthlyReportModal(employeeId) {
            const employee = appState.employees.find(e => e.id === employeeId);
            if (!employee) return;
            document.getElementById('reportModalTitle').textContent = `Monthly Report for ${employee.firstName} ${employee.lastName}`;
            monthlyReportModal._element.dataset.employeeId = employeeId;
            const monthSelect = document.getElementById('report-month'); const yearSelect = document.getElementById('report-year'); const now = new Date();
            if (monthSelect.options.length === 0) {
                 ["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((m, i) => monthSelect.add(new Option(m, i)));
            }
            monthSelect.value = now.getMonth(); yearSelect.innerHTML = '';
            for (let y = now.getFullYear(); y >= now.getFullYear() - 3; y--) yearSelect.add(new Option(y, y));
            yearSelect.value = now.getFullYear();
            renderMonthlyReportForEmployee();
            monthlyReportModal.show();
        }

        function renderMonthlyReportForEmployee() {
            const employeeId = monthlyReportModal._element.dataset.employeeId;
            if (!employeeId) return;
            const month = parseInt(document.getElementById('report-month').value); const year = parseInt(document.getElementById('report-year').value);
            const tableContainer = document.getElementById('report-table-container'); const summaryContainer = document.getElementById('report-summary-container');
            const attendanceRecords = appState.attendance.filter(a => a.employeeId === employeeId);
            const leaveRecords = appState.leaves.filter(l => l.employeeId === employeeId && l.status === 'approved');
            const daysInMonth = new Date(year, month + 1, 0).getDate(); let rowsHtml = ''; 
            
            let summary = { present: 0, absent: 0, holiday: 0, weekend: 0 };
            ALL_LEAVE_KEYS.forEach(key => summary[key] = 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day); const dateStr = getLocalDateString(currentDate); const dayOfWeek = currentDate.getDay();
                let clockIn = '--', clockOut = '--', totalHours = '--', statusBadge = '';
                
                const holiday = HOLIDAYS_2025.find(h => h.date === dateStr);
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                let rowClass = ''; // To hold the CSS class for the row

                if (holiday) {
                     statusBadge = `<span class="badge bg-secondary">Holiday</span>`;
                     rowClass = 'table-row-holiday';
                     summary.holiday++;
                } else if (isWeekend) {
                     statusBadge = `<span class="badge bg-secondary">Weekend</span>`; 
                     rowClass = 'table-row-weekend';
                     summary.weekend++;
                } else {
                    const leaveRecord = leaveRecords.find(l => dateStr >= l.startDate && dateStr <= l.endDate);
                    if (leaveRecord) {
                        statusBadge = `<span class="badge bg-${leaveRecord.type === 'wfh' ? 'warning' : 'info'}">${LEAVE_TYPES[leaveRecord.type].toUpperCase()}</span>`;
                        if (summary.hasOwnProperty(leaveRecord.type)) summary[leaveRecord.type]++;
                    } else {
                        const attendanceRecord = attendanceRecords.find(a => a.date === dateStr);
                        if (attendanceRecord) {
                            clockIn = attendanceRecord.clockIn || '--'; clockOut = attendanceRecord.clockOut || '--'; statusBadge = `<span class="badge bg-success">Present</span>`; summary.present++;
                            if (attendanceRecord.clockIn && attendanceRecord.clockOut) { const start = new Date(`${dateStr}T${attendanceRecord.clockIn}`); const end = new Date(`${dateStr}T${attendanceRecord.clockOut}`); totalHours = !isNaN(start.getTime()) && !isNaN(end.getTime()) ? ((end - start) / 3600000).toFixed(1) + ' hrs' : '--'; }
                        } else { if (currentDate < new Date()) { statusBadge = `<span class="badge bg-danger">Absent</span>`; summary.absent++; } else { statusBadge = `<span class="badge bg-light text-dark">Upcoming</span>`; } }
                    }
                }
                rowsHtml += `<tr class="${rowClass}"><td>${dateStr}</td><td>${clockIn}</td><td>${clockOut}</td><td>${totalHours}</td><td>${statusBadge}</td></tr>`;
            }
            tableContainer.innerHTML = `<table class="table table-hover table-sm"><thead><tr><th>Date</th><th>Clock In</th><th>Clock Out</th><th>Total Hours</th><th>Status</th></tr></thead><tbody>${rowsHtml}</tbody></table>`;
            
            let summaryHtml = `<div class="report-summary-grid">
                <div class="summary-item summary-present"><h5>${summary.present}</h5><p>Present</p></div>
                <div class="summary-item summary-absent"><h5>${summary.absent}</h5><p>Absent</p></div>
                <div class="summary-item summary-weekend"><h5>${summary.weekend + summary.holiday}</h5><p>Off Days</p></div>
                <div class="summary-item summary-wfh"><h5>${summary.wfh}</h5><p>WFH</p></div>`;
            
            ALL_LEAVE_KEYS.filter(k => k !== 'wfh' && summary[k] > 0).forEach(key => {
                summaryHtml += `<div class="summary-item custom-leave"><h5>${summary[key]}</h5><p>${LEAVE_TYPES[key]}</p></div>`;
            });

            summaryHtml += `</div>`;
            summaryContainer.innerHTML = summaryHtml;
        }

        function renderAttendanceRecords() {
            const table = document.getElementById('attendance-table');
            const month = parseInt(document.getElementById('attendance-month').value); 
            const year = parseInt(document.getElementById('attendance-year').value);
            const attendanceRecords = appState.attendance.filter(a => a.employeeId === currentUser.id);
            const leaveRecords = appState.leaves.filter(l => l.employeeId === currentUser.id && l.status === 'approved');
            const today = new Date(); today.setHours(0, 0, 0, 0); 
            const daysInMonth = new Date(year, month + 1, 0).getDate(); 
            let rowsHtml = '';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day); 
                const dateStr = getLocalDateString(currentDate); 
                const dayOfWeek = currentDate.getDay();
                let clockIn = '--', clockOut = '--', totalHours = '--', statusBadge = '';
                let rowClass = ''; // To hold the CSS class for the row

                const holiday = HOLIDAYS_2025.find(h => h.date === dateStr);
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                if (holiday) {
                     statusBadge = `<span class="badge bg-secondary">Holiday</span>`;
                     rowClass = 'table-row-holiday';
                } else if (isWeekend) {
                     statusBadge = `<span class="badge bg-secondary">Weekend</span>`;
                     rowClass = 'table-row-weekend';
                } else {
                    const attendanceRecord = attendanceRecords.find(a => a.date === dateStr);
                    const leaveRecord = leaveRecords.find(l => dateStr >= l.startDate && dateStr <= l.endDate);
                    
                    if (attendanceRecord) {
                        clockIn = new Date(`1970-01-01T${attendanceRecord.clockIn}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit'}) || '--';
                        clockOut = attendanceRecord.clockOut ? new Date(`1970-01-01T${attendanceRecord.clockOut}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit'}) : '--';
                        statusBadge = `<span class="badge bg-success">Present</span>`;
                        if (attendanceRecord.clockIn && attendanceRecord.clockOut) { 
                            const start = new Date(`${dateStr}T${attendanceRecord.clockIn}`); const end = new Date(`${dateStr}T${attendanceRecord.clockOut}`); 
                            totalHours = !isNaN(start.getTime()) && !isNaN(end.getTime()) ? ((end - start) / 3600000).toFixed(1) + ' hours' : '--'; 
                        } else if (attendanceRecord.clockIn) { totalHours = 'In Progress'; }
                    } else if (leaveRecord) { 
                        statusBadge = `<span class="badge bg-${leaveRecord.type === 'wfh' ? 'warning' : 'info'}">${LEAVE_TYPES[leaveRecord.type]}</span>`; 
                    } else { 
                        statusBadge = (currentDate < today) ? `<span class="badge bg-danger">Absent</span>` : `<span class="badge bg-secondary">Upcoming</span>`; 
                    }
                }
                
                rowsHtml += `<tr class="${rowClass}"><td>${dateStr}</td><td>${clockIn}</td><td>${clockOut}</td><td>${totalHours}</td><td>${statusBadge}</td></tr>`;
            }
            table.innerHTML = rowsHtml || `<tr><td colspan="5" class="text-center py-3 text-muted">No records this month.</td></tr>`;
        }
        
        async function handleProfilePicUpload(event) {
            const file = event.target.files[0]; if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64String = e.target.result;
                document.getElementById('profile-pic-preview').src = base64String; document.getElementById('sidebar-avatar').src = base64String;
                if (currentUser) {
                    showLoader();
                    try {
                        await db.updateDocument('employees', currentUser.id, { profilePic: base64String });
                        currentUser.profilePic = base64String; db.setCurrentUser(currentUser);
                        showAlert('Profile picture updated!', 'success');
                    } catch (error) { console.error("Profile Pic Error:", error); } 
                    finally { hideLoader(); }
                }
            };
            reader.readAsDataURL(file);
        }
        
        function handleLogout() { clearAllListeners(); currentUser = null; db.setCurrentUser(null); showAuthScreen(); }
        function showAuthScreen() { DOMElements.dashboard.classList.add('d-none'); DOMElements.authScreen.classList.remove('d-none'); }
        function updateUIForUserRole() { 
            if (!currentUser) return; 
            document.getElementById('user-name').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            const sidebarAvatar = document.getElementById('sidebar-avatar'); sidebarAvatar.src = currentUser.profilePic || `https://ui-avatars.com/api/?name=${currentUser.firstName}+${currentUser.lastName}&background=ffffff&color=4361ee&size=50`;
            const roleEl = document.getElementById('user-role'); roleEl.textContent = currentUser.role; roleEl.className = `user-role role-${currentUser.role}`; 
            
            DOMElements.addNewDepartmentBtn.classList.toggle('d-none', currentUser.role !== 'admin');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('d-none', currentUser.role !== 'admin')); 
            document.querySelectorAll('.manager-admin-only').forEach(el => el.classList.toggle('d-none', !['admin', 'manager'].includes(currentUser.role)));
        }
        
        function renderDashboardStats() {
            const statuses = getDailyStatusesFromCache();
            const nonWfhLeaveKeys = ALL_LEAVE_KEYS.filter(k => k !== 'wfh');
            
            document.getElementById('total-employees').textContent = appState.employees.filter(e => e.status === 'active').length;
            document.getElementById('present-today').textContent = statuses.filter(s => s.status === 'present').length;
            document.getElementById('on-leave').textContent = statuses.filter(s => nonWfhLeaveKeys.includes(s.status)).length;
            document.getElementById('wfh-today').textContent = statuses.filter(s => s.status === 'wfh').length;
        }

        function renderEmployeeStatus() {
            const container = document.getElementById('employee-status-container'); container.innerHTML = '';
            const statuses = getDailyStatusesFromCache();
            if (statuses.length === 0) { container.innerHTML = `<div class="text-center py-4 text-muted">No active employees.</div>`; return; }
            
            statuses.forEach(({employee, status}) => {
                let statusText, statusClass;
                switch(status) {
                    case 'present': statusText = 'Present'; statusClass = 'success'; break;
                    case 'wfh': statusText = 'WFH'; statusClass = 'warning'; break;
                    case 'absent': statusText = 'Absent'; statusClass = 'danger'; break;
                    case 'weekend': statusText = 'Weekend'; statusClass = 'secondary'; break;
                    default: statusText = 'On Leave'; statusClass = 'info'; break;
                }
                const avatarSrc = employee.profilePic || `https://ui-avatars.com/api/?name=${employee.firstName}+${employee.lastName}&background=4361ee&color=fff&size=50`;
                const deptName = allDepartments.find(d => d.id === employee.department)?.name || employee.department.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                container.innerHTML += `<a href="#" class="employee-card view-profile-link text-decoration-none text-dark" data-id="${employee.id}"><img src="${avatarSrc}" class="employee-avatar" loading="lazy"><div class="employee-info"><h6 class="mb-0">${employee.firstName} ${employee.lastName}</h6><small class="text-muted">${deptName}</small></div><span class="status-badge bg-${statusClass}">${statusText}</span></a>`;
            });
        }
        
        function calculatePasswordStrength(password) { let s = 0; if (password.length >= 8) s++; if (/[A-Z]/.test(password)) s++; if (/[a-z]/.test(password)) s++; if (/[0-9]/.test(password)) s++; if (/[^A-Za-z0-9]/.test(password)) s++; return Math.min(s, 4); }
        
        function generateTaskCardHTML(task) {
            const assigner = appState.employees.find(e => e.id === task.assignedBy) || {};
            const completer = appState.employees.find(e => e.id === task.completedBy) || {};
            const canManageAsAdmin = ['admin', 'manager'].includes(currentUser.role);

            // Handle multiple assignees
            const assigneeNames = (Array.isArray(task.assignee) ? task.assignee : [task.assignee])
                .map(id => {
                    const employee = appState.employees.find(e => e.id === id);
                    return employee ? `${employee.firstName} ${employee.lastName}` : 'N/A';
                })
                .join(', ');

            let historyHtml = '';
            if (task.reassignmentHistory && task.reassignmentHistory.length > 0) {
                const lastReassignment = task.reassignmentHistory[task.reassignmentHistory.length - 1];
                const byWhom = appState.employees.find(e => e.id === lastReassignment.by) || {};
                const fromWhom = appState.employees.find(e => e.id === lastReassignment.from) || {};
                const byWhomName = byWhom.firstName ? `${byWhom.firstName} ${byWhom.lastName}` : 'A manager';
                const fromWhomName = fromWhom.firstName ? `${fromWhom.firstName} ${fromWhom.lastName}` : 'the previous assignee';

                let noteHtml = lastReassignment.note
                    ? `<strong class="d-block mb-1"><i class="fas fa-info-circle me-1"></i> Note from ${byWhomName}:</strong> ${lastReassignment.note.replace(/\n/g, '<br>')}`
                    : `<i class="fas fa-info-circle me-1"></i> This task was reassigned by ${byWhomName} from ${fromWhomName}.`;
                
                historyHtml = `<div class="alert alert-info small p-2 mt-2 mb-2" style="background-color: #e8f4fd; border-color: #bde0fe;">${noteHtml}</div>`;
            }
            
            const statusTextHtml = task.status === 'completed' ? `Completed by ${completer.firstName || 'N/A'}` : task.status.replace(/-/g, ' ');

            let actionsHtml = '';
            const isCurrentUserAnAssignee = Array.isArray(task.assignee) ? task.assignee.includes(currentUser.id) : task.assignee === currentUser.id;

            if (isCurrentUserAnAssignee) {
                if (task.status === 'assigned') actionsHtml = `<div class="d-flex mt-2"><button class="btn btn-sm btn-info mark-as-done" data-id="${task.id}">Mark as Done & Decide Next Step</button></div>`; 
                else if (task.status === 'pending-next-step') actionsHtml = `<div class="task-actions mt-2"><p class="small text-muted mb-2">Your action is required. Complete or delegate.</p><button class="btn btn-sm btn-success complete-task" data-id="${task.id}" title="Finish this task for good"><i class="fas fa-check-double"></i> Complete Task</button><button class="btn btn-sm btn-primary assign-to-another" data-id="${task.id}" title="Delegate this task to someone else"><i class="fas fa-random"></i> Assign to Another</button></div>`;
            } else if (canManageAsAdmin) {
                if (task.status === 'pending-next-step') actionsHtml = `<div class="task-actions mt-2"><p class="small text-muted mb-2">Manager action available.</p><button class="btn btn-sm btn-success complete-task" data-id="${task.id}" title="Approve this step and complete the entire task"><i class="fas fa-check-double"></i> Approve & Complete</button><button class="btn btn-sm btn-primary assign-to-another" data-id="${task.id}" title="Re-assign this task to someone else"><i class="fas fa-random"></i> Re-assign</button></div>`;
            }
            
            if (canManageAsAdmin && task.status === 'completed' && !task.appreciation) {
                 actionsHtml += `<button class="btn btn-sm btn-warning give-appreciation mt-2" data-task-id="${task.id}" data-assignee-id="${Array.isArray(task.assignee) ? task.assignee[0] : task.assignee}"><i class="fas fa-medal me-1"></i> Appreciate</button>`;
            }
            
            let attachmentHtml = '';
            if (task.attachment?.url) {
                const { url, type, name } = task.attachment;
                const isDirectLink = type === 'link';
                
                if (type.startsWith('image/')) {
                    attachmentHtml = `<div class="mt-2"><a href="${url}" target="_blank" title="Click to open full image"><img src="${url}" style="max-height: 150px; border-radius: 5px; max-width: 100%; object-fit: cover;" alt="Attachment: ${name}" loading="lazy"></a></div>`;
                } else if (type.startsWith('video/')) {
                     attachmentHtml = `<div class="mt-2"><video controls preload="metadata" style="max-height: 180px; border-radius: 5px; max-width: 100%; background-color: #000;"><source src="${url}" type="${type}"></video><a href="${url}" target="_blank" class="d-block small mt-1" title="View video directly"><i class="fas fa-video me-1"></i> ${name}</a></div>`;
                } else {
                    const iconClass = isDirectLink ? 'fa-link' : 'fa-paperclip';
                    attachmentHtml = `<div class="mt-2"><a href="${url}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas ${iconClass} me-1"></i> View ${isDirectLink ? 'Link' : 'Attachment'}</a></div>`;
                }
            }
            
            const card = document.createElement('div');
            card.id = `task-card-${task.id}`;
            // Task card is now clickable for everyone to view details. The modal will handle edit permissions.
            const managerClickableClass = 'manager-clickable';
            card.className = `card p-3 mb-3 task-card ${task.status} ${managerClickableClass}`;
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">${task.title}</h6>
                    <span class="task-status-badge task-${task.status}" title="${statusTextHtml}">${statusTextHtml}</span>
                </div>
                <p class="mb-2 small">${task.description}</p>
                ${attachmentHtml}
                ${historyHtml}
                <div class="d-flex justify-content-between text-muted small mt-2 mb-2">
                    <span>To: <strong>${assigneeNames}</strong></span>
                    <span>From: ${assigner.firstName || 'Admin'}</span>
                    <span><i class="fas fa-calendar me-1"></i> ${task.deadline}</span>
                </div>
                ${actionsHtml}
                ${task.appreciation ? `<div class="appreciation-card mt-2 p-2"><div class="d-flex align-items-center mb-1"><span class="appreciation-badge me-2"><i class="fas fa-star"></i> Appreciation</span><small>${app.appreciation.date}</small></div><p class="mb-0">${task.appreciation.note}</p></div>` : ''}`;
            
            return card;
        }

        function renderUserTasks() {
            const container = document.getElementById('user-tasks-container'); if (!container) return; 
            const userTasks = appState.tasks.filter(task => {
                const assignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
                return assignees.includes(currentUser.id) && task.status !== 'completed';
            }).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            
            container.innerHTML = '';
            if (userTasks.length === 0) { 
                container.innerHTML = `<div class="text-center p-4 text-muted">You have no active tasks.</div>`; return; 
            }
            userTasks.forEach(task => container.appendChild(generateTaskCardHTML(task)));
        }
        
        function renderTeamTasks() {
            const container = document.getElementById('team-tasks-container'); if (!container) return;
            const filter = document.getElementById('task-filter').value;
            let filteredTasks = (filter !== 'all') ? appState.tasks.filter(task => task.status === filter) : [...appState.tasks];
            filteredTasks.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

            container.innerHTML = '';
            if (filteredTasks.length === 0) { 
                container.innerHTML = `<div class="text-center p-4 text-muted">No tasks found for this filter.</div>`; return; 
            }
            filteredTasks.forEach(task => container.appendChild(generateTaskCardHTML(task)));
        }
        
        function renderAppreciationCard(app) {
            const { employees, tasks } = appState;
            const employee = employees.find(e => e.id == app.employeeId) || {}; const givenBy = employees.find(e => e.id == app.givenBy) || {}; const task = tasks.find(t => t.id == app.taskId) || {};
            const employeeName = employee.id ? `${employee.firstName} ${employee.lastName}` : '[Deleted User]'; const givenByName = givenBy.id ? `${givenBy.firstName} ${givenBy.lastName}` : '[Deleted User]'; const taskTitle = task.id ? task.title : 'General';
            
            const card = document.createElement('div');
            card.className = 'appreciation-card p-3 mb-3';
            card.innerHTML = `<div class="d-flex justify-content-between align-items-center mb-2"><div><span class="appreciation-badge me-2"><i class="fas fa-star"></i> Appreciation</span><small>${app.date}</small></div><small>${app.public ? 'Public' : 'Private'}</small></div><p class="mb-1">${app.note}</p><div class="d-flex justify-content-between text-muted small"><span>To: <strong>${employeeName}</strong></span><span>From: ${givenByName}</span><span>Task: ${taskTitle}</span></div>`;
            return card;
        }

        function renderRecentAppreciations() { 
            const container = document.getElementById('recent-appreciations'); if (!container) return; container.innerHTML = '';
            const recentApps = [...appState.appreciations].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
            if (recentApps.length === 0) { container.innerHTML = `<div class="text-center p-4 text-muted">No appreciations yet.</div>`; return; } 
            recentApps.forEach(app => container.appendChild(renderAppreciationCard(app)));
        }

        function renderTeamAppreciations() { 
            const container = document.getElementById('team-appreciations-container'); if (!container) return; container.innerHTML = ''; 
            const filter = document.getElementById('appreciation-filter').value; 
            let appreciations = [...appState.appreciations].sort((a, b) => new Date(b.date) - new Date(a.date));
            const isEmployee = !['admin', 'manager'].includes(currentUser.role); 
            
            if (filter === 'public' || (isEmployee && filter === 'all')) { appreciations = appreciations.filter(app => app.public); } 
            else if (filter === 'mine') { if (isEmployee) { appreciations = appreciations.filter(app => app.employeeId == currentUser.id); } else { appreciations = appreciations.filter(app => app.givenBy == currentUser.id); } } 
            
            if (appreciations.length === 0) { container.innerHTML = `<div class="text-center p-4 text-muted">No appreciations for this filter.</div>`; return; } 
            appreciations.forEach(app => container.appendChild(renderAppreciationCard(app)));
        }

        function renderAppreciationFormData() { 
            const employeeSelect = document.getElementById('appreciation-employee'); const taskSelect = document.getElementById('appreciation-task'); 
            employeeSelect.innerHTML = '<option value="">Select Employee</option>'; taskSelect.innerHTML = '<option value="">General (No Task)</option>'; 
            appState.employees.forEach(emp => { if (emp.status === 'active' && emp.role !== 'admin') employeeSelect.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id)); }); 
            appState.tasks.forEach(task => { if (task.status === 'completed' && !task.appreciation) taskSelect.add(new Option(task.title, task.id)); }); 
            if (preselectAppreciation) { employeeSelect.value = preselectAppreciation.assigneeId; taskSelect.value = preselectAppreciation.taskId; preselectAppreciation = null; }
        }

        async function handleSaveAppreciation(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true);
            setFormEnabled(DOMElements.appreciationForm, false);
            try {
                const appreciationData = { employeeId: document.getElementById('appreciation-employee').value, taskId: document.getElementById('appreciation-task').value || null, note: document.getElementById('appreciation-note').value, givenBy: currentUser.id, date: getLocalDateString(), public: document.getElementById('appreciation-public').checked };
                if (!appreciationData.employeeId) {
                    showAlert('Please select an employee.', 'warning');
                    return;
                }

                if (appreciationData.taskId) {
                    await db.updateDocument('tasks', appreciationData.taskId, { appreciation: { note: appreciationData.note, givenBy: appreciationData.givenBy, date: appreciationData.date, public: appreciationData.public } });
                    // Optimistic update
                    const taskIndex = appState.tasks.findIndex(t => t.id === appreciationData.taskId);
                    if (taskIndex > -1) appState.tasks[taskIndex].appreciation = appreciationData;
                }

                const docRef = await db.addDocument('appreciations', appreciationData);
                // Optimistic update
                appState.appreciations.unshift({ id: docRef.id, ...appreciationData });

                showAlert('Appreciation submitted!', 'success');
                DOMElements.appreciationForm.reset();
                renderTeamAppreciations();
                renderRecentAppreciations();
                
            } catch (error) { 
                console.error("Save appreciation error:", error); 
                showAlert('Failed to save appreciation.', 'danger');
            } finally { 
                setButtonLoading(submitBtn, false);
                setFormEnabled(DOMElements.appreciationForm, true);
            }
        }

        function renderLeaveBalances() {
            const container = document.getElementById('leave-balance-container'); if (!container || !currentUser) return;
            const remainingCasual = getRemainingLeaveBalance('casual');
            const remainingSick = getRemainingLeaveBalance('sick');
            const balances = currentUser.leaveBalances || { casual: 12, sick: 6 };

            container.innerHTML = `
                <div class="mb-3"><h6>Casual Leave</h6><div class="progress" style="height: 20px;"><div class="progress-bar bg-success" role="progressbar" style="width: ${(remainingCasual / balances.casual) * 100}%;">${remainingCasual} Days</div></div><small class="text-muted">Total: ${balances.casual} days. Used: ${balances.casual - remainingCasual} days.</small></div>
                <div class="mb-3"><h6>Sick Leave</h6><div class="progress" style="height: 20px;"><div class="progress-bar bg-warning text-dark" role="progressbar" style="width: ${(remainingSick / balances.sick) * 100}%;">${remainingSick} Days</div></div><small class="text-muted">Total: ${balances.sick} days. Used: ${balances.sick - remainingSick} days.</small></div>
                <hr><h6>Special Leaves</h6><ul class="list-unstyled small text-muted">
                    <li><i class="fas fa-ring fa-fw me-2 text-primary"></i>Wedding Leave: 5 days (once)</li>
                    <li><i class="fas fa-users fa-fw me-2 text-primary"></i>Bereavement Leave: 7 days</li>
                    <li><i class="fas fa-baby-carriage fa-fw me-2 text-primary"></i>Maternity Leave: 26 weeks</li>
                    <li><i class="fas fa-baby fa-fw me-2 text-primary"></i>Paternity Leave: 5 days</li></ul>`;
        }
        function renderLeaveRequests() { 
            const table = document.getElementById('leave-requests-table'); table.innerHTML = '';
            const requests = appState.leaves.filter(leave => leave.employeeId === currentUser.id).sort((a,b) => new Date(b.startDate) - new Date(a.startDate));
            if (requests.length === 0) { table.innerHTML = `<tr><td colspan="3" class="text-center py-3 text-muted">No requests found.</td></tr>`; return; } 
            requests.forEach(req => { 
                let statusBadge = (req.status === 'approved') ? '<span class="badge bg-success">Approved</span>' : (req.status === 'rejected') ? '<span class="badge bg-danger">Rejected</span>' : '<span class="badge bg-warning">Pending</span>';
                table.innerHTML += `<tr><td>${LEAVE_TYPES[req.type] || req.type}</td><td>${req.startDate} to ${req.endDate}</td><td>${statusBadge}</td></tr>`; 
            }); 
        }
        function renderPendingApprovals() { 
            const container = document.querySelector('#pending-approvals-table').closest('.card');
            if (!['admin', 'manager'].includes(currentUser.role)) { container.classList.add('d-none'); return; } 
            container.classList.remove('d-none'); 

            const table = document.getElementById('pending-approvals-table'); table.innerHTML = '';
            const pendingRequests = appState.leaves.filter(leave => leave.status === 'pending');
            if (pendingRequests.length === 0) { table.innerHTML = `<tr><td colspan="5" class="text-center py-3 text-muted">No pending approvals.</td></tr>`; return; } 
            pendingRequests.forEach(req => { 
                const employee = appState.employees.find(e => e.id == req.employeeId) || {}; 
                table.innerHTML += `<tr><td>${employee.firstName} ${employee.lastName}</td><td>${LEAVE_TYPES[req.type] || req.type}</td><td>${req.startDate} to ${req.endDate}</td><td>${req.reason}</td><td><button class="btn btn-sm btn-success me-1 approve-leave" data-id="${req.id}" data-userid="${employee.id}" title="Approve"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-danger reject-leave" data-id="${req.id}" data-userid="${employee.id}" title="Reject"><i class="fas fa-times"></i></button></td></tr>`; 
            }); 
        }
        async function updateLeaveStatus(leaveId, status, userId) {
            showLoader(); // Using full loader here as it affects multiple users' views.
            try {
                await db.updateDocument('leaves', leaveId, { status: status });

                // --- OPTIMISTIC UI: Update local state and re-render ---
                const leaveIndex = appState.leaves.findIndex(l => l.id === leaveId);
                if (leaveIndex > -1) {
                    appState.leaves[leaveIndex].status = status;
                }
                renderPendingApprovals();
                renderLeaveRequests();
                // ---

                const leaveRequest = appState.leaves.find(l => l.id === leaveId);
                const leaveType = LEAVE_TYPES[leaveRequest.type];
                const msg = `Your request for ${leaveType} (${leaveRequest.startDate}) has been ${status}.`;
                await createNotification(userId, "Leave Request Update", msg, 'leave');
                showAlert(`Request ${status}!`, 'success');
            } catch (error) { 
                console.error("Update leave error:", error); 
                showAlert('Failed to update leave status.', 'danger');
            } 
            finally { hideLoader(); }
        }
        async function handleSaveProfile(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true);
            setFormEnabled(DOMElements.profileForm, false);
            try {
                const profileData = { firstName: document.getElementById('profile-first-name').value, lastName: document.getElementById('profile-last-name').value, email: document.getElementById('profile-email').value, phone: document.getElementById('profile-phone').value, department: document.getElementById('profile-department').value, dob: document.getElementById('profile-dob').value, address: document.getElementById('profile-address').value };
                await db.updateDocument('employees', currentUser.id, profileData);
                
                // --- OPTIMISTIC UI: Update local and session storage ---
                currentUser = { ...currentUser, ...profileData }; 
                db.setCurrentUser(currentUser);
                const employeeIndex = appState.employees.findIndex(e => e.id === currentUser.id);
                if(employeeIndex > -1) appState.employees[employeeIndex] = currentUser;
                // ---

                updateUIForUserRole(); 
                showAlert('Profile updated!', 'success');
            } catch (error) { 
                console.error("Profile update error:", error);
                showAlert('Failed to update profile.', 'danger');
            } 
            finally { 
                setButtonLoading(submitBtn, false);
                setFormEnabled(DOMElements.profileForm, true);
            }
        }
        async function handleChangePassword(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const currentPassword = document.getElementById('current-password').value; const newPassword = document.getElementById('new-password').value; const confirmPassword = document.getElementById('confirm-password').value;
            if (currentPassword !== currentUser.password) { showAlert('Current password is incorrect.', 'danger'); return; }
            if (newPassword !== confirmPassword) { showAlert('New passwords do not match.', 'danger'); return; }
            if (newPassword.length < 6) { showAlert('Password must be at least 6 characters.', 'danger'); return; }
            
            setButtonLoading(submitBtn, true);
            setFormEnabled(DOMElements.passwordForm, false);

            try {
                await db.updateDocument('employees', currentUser.id, { password: newPassword });
                
                // --- OPTIMISTIC UI: Update local and session storage ---
                currentUser.password = newPassword; 
                db.setCurrentUser(currentUser);
                // ---

                showAlert('Password changed!', 'success'); 
                DOMElements.passwordForm.reset();
            } catch (error) { 
                console.error("Password change error:", error);
                showAlert('Failed to change password.', 'danger');
            } 
            finally { 
                setButtonLoading(submitBtn, false);
                setFormEnabled(DOMElements.passwordForm, true);
            }
        }
        function renderAnalyticsCharts() {
            Chart.getChart("attendance-chart")?.destroy(); Chart.getChart("tasks-chart")?.destroy(); Chart.getChart("leave-chart")?.destroy(); Chart.getChart("performance-chart")?.destroy();
            new Chart(document.getElementById('attendance-chart').getContext('2d'), { type: 'bar', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'], datasets: [{ label: 'Present', data: [22, 24, 23, 25, 24], backgroundColor: '#10b981', }, { label: 'WFH', data: [3, 2, 4, 3, 4], backgroundColor: '#f59e0b', }, { label: 'Absent', data: [1, 0, 0, 0, 2], backgroundColor: '#ef4444', }] }, options: { responsive: true, maintainAspectRatio: false } });
            const { tasks, leaves } = appState;
            const completed = tasks.filter(t => t.status === 'completed').length; const assigned = tasks.filter(t => t.status === 'assigned').length; const pending = tasks.filter(t => t.status === 'pending-next-step').length; const missed = tasks.filter(t => t.status === 'missed').length; new Chart(document.getElementById('tasks-chart').getContext('2d'), { type: 'doughnut', data: { labels: ['Completed', 'Assigned', 'Pending Next Step', 'Missed'], datasets: [{ data: [completed, assigned, pending, missed], backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#ef4444'], }] }, options: { responsive: true, maintainAspectRatio: false } });
            const approved = leaves.filter(l => l.status === 'approved').length; const pendingLeave = leaves.filter(l => l.status === 'pending').length; const rejected = leaves.filter(l => l.status === 'rejected').length; new Chart(document.getElementById('leave-chart').getContext('2d'), { type: 'pie', data: { labels: ['Approved', 'Pending', 'Rejected'], datasets: [{ data: [approved, pendingLeave, rejected], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], }] }, options: { responsive: true, maintainAspectRatio: false } });
            new Chart(document.getElementById('performance-chart').getContext('2d'), { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'], datasets: [{ label: 'Performance Score', data: [75, 82, 78, 85, 88, 90, 92], borderColor: '#4361ee', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 50, max: 100 } } } });
        }
        function renderProfileData() {
            if (!currentUser) return;
            populateDepartmentDropdown(document.getElementById('profile-department'));
            document.getElementById('profile-pic-preview').src = currentUser.profilePic || `https://ui-avatars.com/api/?name=${currentUser.firstName}+${currentUser.lastName}&background=4361ee&color=fff&size=120`;
            document.getElementById('profile-first-name').value = currentUser.firstName; document.getElementById('profile-last-name').value = currentUser.lastName;
            document.getElementById('profile-email').value = currentUser.email; document.getElementById('profile-phone').value = currentUser.phone || '';
            document.getElementById('profile-department').value = currentUser.department; document.getElementById('profile-dob').value = currentUser.dob || '';
            document.getElementById('profile-address').value = currentUser.address || '';
        }
        
        function openTaskModalForAdd() {
            DOMElements.taskForm.reset();
            document.getElementById('task-id').value = '';
            document.getElementById('taskModalTitle').textContent = 'Create New Task';
            document.getElementById('existing-attachment-info').innerHTML = '';
            
            const assigneeSelect = document.getElementById('task-assignee');
            assigneeSelect.innerHTML = ''; // Clear previous options
            appState.employees.forEach(emp => {
                if (emp.status === 'active') {
                    assigneeSelect.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id));
                }
            });
            setFormEnabled(DOMElements.taskForm, true);
            document.getElementById('save-task-btn').style.display = 'inline-block';

            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('task-deadline').value = tomorrow.toISOString().split('T')[0];
            taskModal.show();
        }

        function openTaskModalForEdit(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) { showAlert('Task not found or could not be loaded.', 'danger'); return; }

            DOMElements.taskForm.reset();
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description;
            document.getElementById('task-deadline').value = task.deadline;
            document.getElementById('task-priority').value = task.priority;

            const assigneeSelect = document.getElementById('task-assignee');
            assigneeSelect.innerHTML = ''; // Clear previous options
            appState.employees.forEach(emp => {
                if (emp.status === 'active') {
                    const option = new Option(`${emp.firstName} ${emp.lastName}`, emp.id);
                    const taskAssignees = Array.isArray(task.assignee) ? task.assignee : [task.assignee];
                    if (taskAssignees.includes(emp.id)) {
                        option.selected = true;
                    }
                    assigneeSelect.add(option);
                }
            });
            
            const attachmentInfo = document.getElementById('existing-attachment-info');
            if (task.attachment?.url) {
                attachmentInfo.innerHTML = `<div class="alert alert-light p-2 small">Current Attachment: <a href="${task.attachment.url}" target="_blank">${task.attachment.name}</a></div>`;
            } else { attachmentInfo.innerHTML = ''; }
            
            // --- NEW LOGIC FOR PERMISSIONS ---
            const canManage = ['admin', 'manager'].includes(currentUser.role);
            const saveBtn = document.getElementById('save-task-btn');
            
            // Use the helper to enable/disable the whole form
            setFormEnabled(DOMElements.taskForm, canManage);
            
            // Adjust button visibility and modal title
            saveBtn.style.display = canManage ? 'inline-block' : 'none';
            document.getElementById('taskModalTitle').textContent = canManage ? 'Edit Task Details' : 'View Task Details';

            taskModal.show();
        }

        async function handleSaveTask() {
            const saveBtn = DOMElements.saveTaskBtn;
            const taskId = document.getElementById('task-id').value;
            const fileInput = document.getElementById('task-attachment-file');
            const file = fileInput.files[0];
            const link = document.getElementById('task-attachment-link').value.trim();

            const assigneeSelect = document.getElementById('task-assignee');
            const selectedAssignees = Array.from(assigneeSelect.selectedOptions).map(option => option.value);

            if (selectedAssignees.length === 0) { showAlert("Please assign the task to at least one employee.", "warning"); return; }
            if (!document.getElementById('task-title').value.trim()) { showAlert("Please enter a task title.", "warning"); return; }
            
            setButtonLoading(saveBtn, true);
            setFormEnabled(DOMElements.taskForm, false);
            try {
                const existingTask = taskId ? appState.tasks.find(t => t.id === taskId) : null;

                let taskData = { 
                    title: document.getElementById('task-title').value, 
                    description: document.getElementById('task-description').value, 
                    assignee: selectedAssignees,
                    deadline: document.getElementById('task-deadline').value, 
                    priority: document.getElementById('task-priority').value,
                };
                
                let attachmentData = existingTask ? existingTask.attachment : null;
                if (file) {
                    const filePath = `task-attachments/${new Date().getTime()}_${file.name}`;
                    const fileRef = ref(storage, filePath);
                    const uploadResult = await uploadBytes(fileRef, file);
                    attachmentData = { url: await getDownloadURL(uploadResult.ref), type: file.type, name: file.name };
                } else if (link) {
                    attachmentData = { url: link, type: 'link', name: 'Web Link' };
                }
                taskData.attachment = attachmentData;

                if (taskId) {
                    await db.updateDocument('tasks', taskId, taskData); 
                    
                    const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) appState.tasks[taskIndex] = { ...appState.tasks[taskIndex], ...taskData };
                    showAlert('Task updated successfully!', 'success');
                    
                    const notificationPromises = taskData.assignee
                        .filter(assigneeId => assigneeId !== currentUser.id)
                        .map(assigneeId => createNotification(assigneeId, "Task Updated", `The task "${taskData.title}" was updated by ${currentUser.firstName}.`, 'tasks', { taskId: taskId }));
                    await Promise.all(notificationPromises);

                } else {
                    taskData = { ...taskData, assignedBy: currentUser.id, originalAssigner: currentUser.id, status: "assigned", createdAt: new Date().toISOString(), reassignmentHistory: [], };
                    const docRef = await db.addDocument('tasks', taskData); 
                    
                    appState.tasks.unshift({ id: docRef.id, ...taskData });
                    showAlert('Task created successfully!', 'success');
                    
                    const notificationPromises = taskData.assignee
                        .map(assigneeId => createNotification(assigneeId, "New Task Assigned", `${currentUser.firstName} assigned you: "${taskData.title}".`, 'tasks', { taskId: docRef.id }));
                    await Promise.all(notificationPromises);
                }
                
                renderUserTasks();
                renderTeamTasks();
                taskModal.hide(); 

            } catch (error) { 
                console.error("Task save error:", error); 
                showAlert("Failed to save task. Check console for details.", "danger");
            } finally { 
                setButtonLoading(saveBtn, false);
                setFormEnabled(DOMElements.taskForm, true);
                fileInput.value = '';
                document.getElementById('task-attachment-link').value = '';
            }
        }


        async function markTaskAsPending(taskId) {
            showLoader(); // Use full loader as it's a significant status change
            try {
                await db.updateDocument('tasks', taskId, { status: 'pending-next-step' });
                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) appState.tasks[taskIndex].status = 'pending-next-step';
                renderUserTasks();
                renderTeamTasks();
                showAlert('Task marked as done. Now decide the next step.', 'info');
            } catch (error) {
                console.error("Error updating task status:", error);
                showAlert("Failed to update task status.", "danger");
            } finally { hideLoader(); }
        }

        async function completeTask(taskId) {
            showLoader();
            try {
                const task = appState.tasks.find(t => t.id === taskId);
                if (!task) throw new Error("Task not found");
                
                const updateData = { status: "completed", completedOn: getLocalDateString(), completedBy: currentUser.id };
                await db.updateDocument('tasks', taskId, updateData);

                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) appState.tasks[taskIndex] = { ...appState.tasks[taskIndex], ...updateData };
                renderUserTasks();
                renderTeamTasks();

                showAlert('Task has been successfully completed!', 'success');

                if (task.originalAssigner && task.originalAssigner !== currentUser.id) {
                    const completerName = `${currentUser.firstName} ${currentUser.lastName}`;
                    await createNotification(task.originalAssigner, "Task Completed", `The task you originally assigned, "${task.title}", has been completed by ${completerName}.`, 'tasks', { taskId: taskId });
                }
            } catch (error) {
                console.error("Task completion error:", error);
                showAlert("Failed to complete the task.", "danger");
            } finally { hideLoader(); }
        }
        
        async function openReassignModal(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) { showAlert('Task not found.', 'danger'); return; }
            document.getElementById('reassign-task-form').reset();
            document.getElementById('reassign-task-id').value = taskId;
            document.getElementById('reassign-task-title').value = task.title;
            const assigneeSelect = document.getElementById('reassign-task-assignee');
            assigneeSelect.innerHTML = '<option value="">Select Employee</option>';
            appState.employees.forEach(emp => { if (emp.status === 'active') assigneeSelect.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id)); });
            document.getElementById('reassign-task-deadline').value = task.deadline;
            reassignTaskModal.show();
        }
        
        async function handleReassignTask() {
            const saveBtn = DOMElements.saveReassignBtn;
            const taskId = document.getElementById('reassign-task-id').value;
            const newAssigneeId = document.getElementById('reassign-task-assignee').value;
            const newDeadline = document.getElementById('reassign-task-deadline').value;
            const fieldNotes = document.getElementById('reassign-field-notes').value;
            const fileInput = document.getElementById('reassign-task-attachment-file');
            const file = fileInput.files[0];
            const link = document.getElementById('reassign-task-attachment-link').value.trim();

            if (!newAssigneeId) { showAlert('Please select an employee.', 'warning'); return; }
            
            setButtonLoading(saveBtn, true);
            setFormEnabled(document.getElementById('reassign-task-form'), false);
            
            try {
                const task = appState.tasks.find(t => t.id === taskId);
                if (!task) throw new Error("Task not found");

                let newAttachmentData = task.attachment;
                if (file) {
                    const filePath = `task-attachments/${new Date().getTime()}_${file.name}`;
                    const fileRef = ref(storage, filePath);
                    const uploadResult = await uploadBytes(fileRef, file);
                    newAttachmentData = { url: await getDownloadURL(uploadResult.ref), type: file.type, name: file.name };
                } else if (link) {
                    newAttachmentData = { url: link, type: 'link', name: 'Web Link' };
                }

                const historyEntry = { from: task.assignee, to: newAssigneeId, by: currentUser.id, date: new Date().toISOString(), note: fieldNotes };
                const updatedHistory = task.reassignmentHistory ? [...task.reassignmentHistory, historyEntry] : [historyEntry];

                const updateData = { 
                    assignee: [newAssigneeId], 
                    deadline: newDeadline, 
                    status: 'assigned', 
                    assignedBy: currentUser.id,
                    reassignmentHistory: updatedHistory, 
                    attachment: newAttachmentData
                };

                await db.updateDocument('tasks', taskId, updateData);
                
                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) appState.tasks[taskIndex] = { ...appState.tasks[taskIndex], ...updateData };
                renderUserTasks();
                renderTeamTasks();

                reassignTaskModal.hide();
                showAlert('Task has been delegated successfully!', 'success');
                
                await createNotification(newAssigneeId, "New Task Assigned", `${currentUser.firstName} assigned you: "${task.title}".`, 'tasks', { taskId: taskId });
            } catch (error) {
                console.error("Task re-assignment error:", error);
                showAlert("Failed to delegate the task.", "danger");
            } finally {
                setButtonLoading(saveBtn, false);
                setFormEnabled(document.getElementById('reassign-task-form'), true);
                fileInput.value = ''; document.getElementById('reassign-task-attachment-link').value = '';
            }
        }

        async function handleSaveLeave(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true);
            setFormEnabled(DOMElements.leaveForm, false);
            try {
                const leaveData = {
                    employeeId: currentUser.id, type: document.getElementById('leave-type').value,
                    startDate: document.getElementById('leave-start').value, endDate: document.getElementById('leave-end').value,
                    reason: document.getElementById('leave-reason').value, status: "pending"
                };
                if (new Date(leaveData.endDate) < new Date(leaveData.startDate)) { 
                    showAlert('End date cannot be before start date.', 'warning'); 
                    return; 
                }
                if (leaveData.type === 'casual') {
                    const requestedDays = (new Date(leaveData.endDate) - new Date(leaveData.startDate)) / (1000*60*60*24) + 1;
                    if (requestedDays > getRemainingLeaveBalance('casual')) leaveData.type = 'lop';
                }

                const docRef = await db.addDocument('leaves', leaveData);
                
                appState.leaves.unshift({ id: docRef.id, ...leaveData });
                renderLeaveRequests();

                showAlert('Request submitted!', 'success');
                DOMElements.leaveForm.reset();
                const recipients = appState.employees.filter(e => e.status === 'active' && ['admin', 'manager'].includes(e.role));
                const promises = recipients.map(r => createNotification(r.id, "New Leave Request", `${currentUser.firstName} requested ${LEAVE_TYPES[leaveData.type]}.`, 'leave'));
                await Promise.all(promises);
            } catch (error) { 
                console.error("Leave save error:", error); 
                showAlert('Failed to save leave request.', 'danger');
            } 
            finally { 
                setButtonLoading(submitBtn, false);
                setFormEnabled(DOMElements.leaveForm, true);
            }
        }

        function showAlert(message, type = 'info') { const alertContainer = document.getElementById('alert-container'); const alert = document.createElement('div'); alert.className = `alert alert-${type} alert-dismissible fade show`; alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`; alertContainer.appendChild(alert); setTimeout(() => bootstrap.Alert.getOrCreateInstance(alert)?.close(), 5000); }
        
        function openEmployeeModalForAdd() { DOMElements.employeeForm.reset(); document.getElementById('employee-id').value = ''; document.getElementById('employeeModalTitle').textContent = 'Add New Employee'; document.getElementById('status-field-group').classList.add('d-none'); document.getElementById('password-field-group').classList.remove('d-none'); document.getElementById('employee-password').required = true; populateDepartmentDropdown(document.getElementById('employee-department')); employeeModal.show(); }
        
        async function handleSaveEmployee() {
            const saveBtn = DOMElements.saveEmployeeBtn;
            const id = document.getElementById('employee-id').value;
            const employeeData = { firstName: document.getElementById('employee-first-name').value, lastName: document.getElementById('employee-last-name').value, email: document.getElementById('employee-email').value, department: document.getElementById('employee-department').value, role: document.getElementById('employee-role').value, status: document.getElementById('employee-status').value || 'active' };
            
            setButtonLoading(saveBtn, true);
            setFormEnabled(DOMElements.employeeForm, false);
            try {
                if (id) {
                    await db.updateDocument('employees', id, employeeData);
                    const index = appState.employees.findIndex(e => e.id === id);
                    if (index > -1) appState.employees[index] = { ...appState.employees[index], ...employeeData };
                    showAlert('Employee updated.', 'success');
                } else {
                    employeeData.password = document.getElementById('employee-password').value; employeeData.joinDate = getLocalDateString();
                    employeeData.leaveBalances = { casual: 12, sick: 6 };
                    const docRef = await db.addDocument('employees', employeeData);
                    appState.employees.push({ id: docRef.id, ...employeeData });
                    showAlert('Employee created.', 'success');
                }
                renderEmployees(); // Re-render the table immediately
                employeeModal.hide(); 
            } catch (error) { 
                console.error("Employee save error:", error); 
                showAlert('Failed to save employee data.', 'danger');
            } 
            finally { 
                setButtonLoading(saveBtn, false);
                setFormEnabled(DOMElements.employeeForm, true);
            }
        }
        function renderEmployees() {
            const table = document.getElementById('employees-table'); table.innerHTML = '';
            if (appState.employees.length === 0) { table.innerHTML = `<tr><td colspan="6" class="text-center py-3 text-muted">No employees found.</td></tr>`; return; }
            appState.employees.forEach(emp => {
                let statusBadge = `<span class="badge bg-${emp.status === 'active' ? 'success' : 'danger'}">${emp.status === 'active' ? 'Active' : 'Inactive'}</span>`;
                let roleBadge = `<span class="badge role-${emp.role}">${emp.role.charAt(0).toUpperCase() + emp.role.slice(1)}</span>`;
                const deptName = allDepartments.find(d => d.id === emp.department)?.name || emp.department.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                table.innerHTML += `<tr><td>${emp.firstName} ${emp.lastName}</td><td>${emp.email}</td><td>${deptName}</td><td>${roleBadge}</td><td>${statusBadge}</td><td><button class="btn btn-sm btn-outline-info me-2 view-profile-btn" data-id="${emp.id}" title="View Profile"><i class="fas fa-eye"></i></button><button class="btn btn-sm btn-outline-primary me-2 edit-employee" data-id="${emp.id}"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-sm btn-outline-danger delete-employee" data-id="${emp.id}"><i class="fas fa-trash-alt"></i> Delete</button></td></tr>`;
            });
        }
        async function openEmployeeModalForEdit(employeeId) {
            const employee = appState.employees.find(e => e.id === employeeId);
            if (!employee) return;
            populateDepartmentDropdown(document.getElementById('employee-department'));
            document.getElementById('employee-id').value = employee.id; document.getElementById('employee-first-name').value = employee.firstName; document.getElementById('employee-last-name').value = employee.lastName; document.getElementById('employee-email').value = employee.email; document.getElementById('employee-department').value = employee.department; document.getElementById('employee-role').value = employee.role; document.getElementById('employee-status').value = employee.status; document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
            document.getElementById('status-field-group').classList.remove('d-none'); document.getElementById('password-field-group').classList.add('d-none'); document.getElementById('employee-password').required = false;
            employeeModal.show();
        }
        async function handleDeleteEmployee(employeeId) {
            if (employeeId == currentUser.id) { showAlert("You cannot delete your own account.", "warning"); return; }
            if (confirm("Are you sure? This action is permanent.")) {
                showLoader();
                try {
                    await db.deleteDocument('employees', employeeId);
                    appState.employees = appState.employees.filter(e => e.id !== employeeId);
                    renderEmployees();
                    showAlert("Employee deleted.", "success");
                } catch (error) { 
                    console.error("Delete employee error:", error); 
                    showAlert("Failed to delete employee.", "danger");
                } 
                finally { hideLoader(); }
            }
        }

        function handleTaskCardClick(e) {
            const target = e.target;
            const actionButton = target.closest('button');

            if (actionButton) {
                // Handle specific button clicks inside the card
                if (actionButton.classList.contains('mark-as-done')) markTaskAsPending(actionButton.dataset.id);
                else if (actionButton.classList.contains('complete-task')) completeTask(actionButton.dataset.id);
                else if (actionButton.classList.contains('assign-to-another')) openReassignModal(actionButton.dataset.id);
                else if (actionButton.closest('.give-appreciation')) {
                    const btn = actionButton.closest('.give-appreciation');
                    preselectAppreciation = { taskId: btn.dataset.taskId, assigneeId: btn.dataset.assigneeId }; 
                    document.querySelector('[data-view="appreciations"]').click();
                }
                return; // Stop propagation to prevent card click
            }
            
            // If the click was not on a button, check if the card itself should be clickable
            const taskCard = target.closest('.task-card');
            if (taskCard) {
                const taskId = taskCard.id.replace('task-card-', '');
                // FIX: Open for everyone; modal will handle permissions.
                openTaskModalForEdit(taskId);
            }
        }
        function handleEmployeeTableClick(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('edit-employee')) openEmployeeModalForEdit(id);
            else if (target.classList.contains('delete-employee')) handleDeleteEmployee(id);
        }
        function handleLeaveApprovalClick(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const userId = target.dataset.userid;
            if (target.classList.contains('approve-leave')) updateLeaveStatus(id, 'approved', userId);
            else if (target.classList.contains('reject-leave')) updateLeaveStatus(id, 'rejected', userId);
        }
        function handleAdminDashboardClick(e) {
            const target = e.target.closest('button');
            if (!target || !target.classList.contains('view-report-btn')) return;
            openMonthlyReportModal(target.dataset.id);
        }

        function renderActivities() {
            const tableBody = document.getElementById('activities-table-body');
            tableBody.innerHTML = '';
            const activities = appState.activities.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if (activities.length === 0) {
                const colSpan = ['admin', 'manager'].includes(currentUser.role) ? 6 : 5;
                tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center p-4 text-muted">No development activities logged yet.</td></tr>`;
                return;
            }

            activities.forEach(activity => {
                const attendeesCount = activity.attendees ? activity.attendees.length : 0;
                tableBody.innerHTML += `
                    <tr class="align-middle">
                        <td>${activity.date}</td><td>${activity.name}</td><td>${activity.topic}</td><td>${activity.duration}</td><td>${attendeesCount} attendees</td>
                        <td class="manager-admin-only">
                            <button class="btn btn-sm btn-outline-primary me-2 edit-activity" data-id="${activity.id}" title="Edit Activity"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-activity" data-id="${activity.id}" title="Delete Activity"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
            });
            // These event listeners will be handled by a parent delegate
        }
        function openActivityModalForAdd() {
            document.getElementById('activity-form').reset(); document.getElementById('activity-id').value = '';
            document.getElementById('activityModalTitle').textContent = 'Log New Activity';
            const attendeeSelect = document.getElementById('activity-attendance'); attendeeSelect.innerHTML = '';
            appState.employees.filter(e => e.status === 'active').forEach(emp => { attendeeSelect.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id)); });
            document.getElementById('activity-date').value = getLocalDateString();
            activityModal.show();
        }
        function openActivityModalForEdit(activityId) {
            const activity = appState.activities.find(a => a.id === activityId); if (!activity) return;
            document.getElementById('activity-form').reset(); document.getElementById('activity-id').value = activity.id;
            document.getElementById('activityModalTitle').textContent = 'Edit Activity';
            document.getElementById('activity-name').value = activity.name; document.getElementById('activity-date').value = activity.date;
            document.getElementById('activity-duration').value = activity.duration; document.getElementById('activity-topic').value = activity.topic;
            document.getElementById('activity-notes').value = activity.notes || '';
            const attendeeSelect = document.getElementById('activity-attendance'); attendeeSelect.innerHTML = '';
            appState.employees.filter(e => e.status === 'active').forEach(emp => {
                const option = new Option(`${emp.firstName} ${emp.lastName}`, emp.id);
                if (activity.attendees?.includes(emp.id)) option.selected = true;
                attendeeSelect.add(option);
            });
            activityModal.show();
        }
        async function handleSaveActivity() {
            const saveBtn = DOMElements.saveActivityBtn;
            setButtonLoading(saveBtn, true);
            setFormEnabled(document.getElementById('activity-form'), false);
            const id = document.getElementById('activity-id').value;
            try {
                const activityData = {
                    name: document.getElementById('activity-name').value, date: document.getElementById('activity-date').value,
                    duration: document.getElementById('activity-duration').value, topic: document.getElementById('activity-topic').value,
                    attendees: Array.from(document.getElementById('activity-attendance').selectedOptions).map(opt => opt.value),
                    notes: document.getElementById('activity-notes').value, createdBy: currentUser.id, lastUpdated: new Date().toISOString()
                };
                if(!activityData.name || !activityData.date || !activityData.duration || !activityData.topic) { showAlert("Please fill all required fields.", "warning"); return; }
                if (id) { 
                    await db.updateDocument('activities', id, activityData); 
                    const index = appState.activities.findIndex(a => a.id === id);
                    if (index > -1) appState.activities[index] = {id, ...activityData};
                    showAlert('Activity updated successfully.', 'success'); 
                }
                else { 
                    const docRef = await db.addDocument('activities', activityData); 
                    appState.activities.unshift({id: docRef.id, ...activityData});
                    showAlert('Activity logged successfully.', 'success'); 
                }
                renderActivities();
                activityModal.hide();
            } catch (error) { console.error("Save activity error:", error); showAlert("Failed to save activity.", "danger");} 
            finally { 
                setButtonLoading(saveBtn, false);
                setFormEnabled(document.getElementById('activity-form'), true);
            }
        }
        async function handleDeleteActivity(activityId) {
             if (confirm("Are you sure?")) {
                showLoader();
                try { 
                    await db.deleteDocument('activities', activityId);
                    appState.activities = appState.activities.filter(a => a.id !== activityId);
                    renderActivities();
                    showAlert("Activity deleted.", "success"); 
                }
                catch (error) { console.error("Delete activity error:", error); } 
                finally { hideLoader(); }
            }
        }
        function renderLearningGoals() {
            const isManager = ['admin', 'manager'].includes(currentUser.role);
            const employeeFilter = document.getElementById('goal-employee-filter');
            const title = document.getElementById('learning-goals-title');
            let targetEmployeeId = !isManager ? currentUser.id : employeeFilter.value;
            
            if (isManager) {
                title.textContent = "Team Learning Goals";
                if (employeeFilter.options.length === 0) {
                    employeeFilter.innerHTML = `<option value="all">All Employees</option>`;
                    appState.employees.filter(e => e.status === 'active').forEach(emp => employeeFilter.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id)));
                }
                if(employeeFilter.value !== 'all') {
                    const selectedEmployee = appState.employees.find(e => e.id === employeeFilter.value);
                    if(selectedEmployee) title.textContent = `Goals for ${selectedEmployee.firstName}`;
                }
            } else { title.textContent = "Your Learning Goals"; }
            
            const goals = (isManager && targetEmployeeId === 'all') ? appState.learningGoals : appState.learningGoals.filter(g => g.employeeId === targetEmployeeId);
            goals.sort((a,b) => new Date(b.assignedDate) - new Date(a.assignedDate));

            const containers = { week: document.getElementById('goals-this-week-container'), month: document.getElementById('goals-this-month-container'), previous: document.getElementById('goals-previous-month-container') };
            Object.values(containers).forEach(c => c.innerHTML = '');

            const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const firstDayOfWeek = new Date(today); firstDayOfWeek.setDate(today.getDate() - today.getDay());
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const firstDayOfPrevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastDayOfPrevMonth = new Date(today.getFullYear(), today.getMonth(), 0);

            goals.forEach(goal => {
                const goalDate = new Date(goal.assignedDate + "T00:00:00");
                let container = null;
                if (goalDate >= firstDayOfWeek) container = containers.week;
                else if (goalDate >= firstDayOfMonth) container = containers.month;
                else if (goalDate >= firstDayOfPrevMonth && goalDate <= lastDayOfPrevMonth) container = containers.previous;
                if (container) container.innerHTML += generateGoalCardHTML(goal);
            });
            Object.values(containers).forEach(c => { if (c.innerHTML === '') c.innerHTML = `<div class="text-center p-3 text-muted small">No goals in this period.</div>`; });
        }
        function generateGoalCardHTML(goal) {
            const employee = appState.employees.find(e => e.id === goal.employeeId) || {};
            const canManage = ['admin', 'manager'].includes(currentUser.role);
            const statusClasses = { pending: 'warning', 'in-progress': 'info', completed: 'success' };
            const statusBadge = `<span class="badge bg-${statusClasses[goal.status]}">${goal.status.replace('-', ' ')}</span>`;
            const editButtonHtml = canManage ? `<button class="btn btn-sm btn-outline-secondary ms-2 edit-goal-btn" data-id="${goal.id}" title="Edit Goal"><i class="fas fa-edit"></i></button>` : '';
            return `<div class="card goal-card"><div class="card-body">
                         <div class="d-flex justify-content-between align-items-start"><p class="mb-2 w-75">${goal.description}</p>${statusBadge}</div>
                        ${canManage && document.getElementById('goal-employee-filter').value === 'all' ? `<small class="text-muted d-block mb-2">For: <strong>${employee.firstName} ${employee.lastName}</strong></small>` : ''}
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="d-flex align-items-center">
                                <select class="form-select form-select-sm w-auto goal-status-select" data-id="${goal.id}">
                                    <option value="pending" ${goal.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="in-progress" ${goal.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${goal.status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>${editButtonHtml}</div><small class="text-muted">Set: ${goal.assignedDate}</small></div>
                        ${goal.reviewComments ? `<div class="mt-2 p-2 bg-light rounded small"><strong class="d-block">Review:</strong>${goal.reviewComments}</div>` : ''}
                    </div></div>`;
        }
        async function updateGoalStatus(goalId, newStatus) {
            showLoader();
            try { 
                await db.updateDocument('learningGoals', goalId, { status: newStatus });
                const index = appState.learningGoals.findIndex(g => g.id === goalId);
                if (index > -1) appState.learningGoals[index].status = newStatus;
                renderLearningGoals();
            }
            catch (error) { console.error("Error updating goal status:", error); } 
            finally { hideLoader(); }
        }
        function openGoalModalForAdd() {
            document.getElementById('goal-form').reset(); document.getElementById('goal-id').value = '';
            document.getElementById('goalModalTitle').textContent = 'Add New Goal';
            const employeeSelect = document.getElementById('goal-employee'); employeeSelect.innerHTML = '';
            if (['admin', 'manager'].includes(currentUser.role)) appState.employees.filter(e => e.status === 'active').forEach(emp => employeeSelect.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id)));
            else { employeeSelect.add(new Option(`${currentUser.firstName} ${currentUser.lastName}`, currentUser.id)); employeeSelect.value = currentUser.id; }
            document.getElementById('goal-assigned-date').value = getLocalDateString();
            goalModal.show();
        }
        function openGoalModalForEdit(goalId) {
            const goal = appState.learningGoals.find(g => g.id === goalId); if (!goal) return;
            document.getElementById('goal-form').reset(); document.getElementById('goal-id').value = goal.id;
            document.getElementById('goalModalTitle').textContent = 'Edit Learning Goal';
            const employeeSelect = document.getElementById('goal-employee'); employeeSelect.innerHTML = '';
            appState.employees.filter(e => e.status === 'active').forEach(emp => employeeSelect.add(new Option(`${emp.firstName} ${emp.lastName}`, emp.id)));
            employeeSelect.value = goal.employeeId;
            document.getElementById('goal-description').value = goal.description;
            document.getElementById('goal-assigned-date').value = goal.assignedDate;
            document.getElementById('goal-status').value = goal.status;
            document.getElementById('goal-review').value = goal.reviewComments || '';
            goalModal.show();
        }
        async function handleSaveGoal() {
            const saveBtn = DOMElements.saveGoalBtn;
            setButtonLoading(saveBtn, true);
            setFormEnabled(document.getElementById('goal-form'), false);

            const id = document.getElementById('goal-id').value;
            try {
                 const goalData = {
                    employeeId: document.getElementById('goal-employee').value, description: document.getElementById('goal-description').value,
                    assignedDate: document.getElementById('goal-assigned-date').value, status: document.getElementById('goal-status').value,
                    reviewComments: document.getElementById('goal-review').value, assignedBy: currentUser.id
                };
                if (!goalData.employeeId || !goalData.description || !goalData.assignedDate) { showAlert('Please fill all required fields.', 'warning'); return; }
                
                if (id) { 
                    await db.updateDocument('learningGoals', id, goalData); 
                    const index = appState.learningGoals.findIndex(g => g.id === id);
                    if (index > -1) appState.learningGoals[index] = {id, ...goalData};
                    showAlert('Learning goal updated!', 'success'); 
                }
                else { 
                    const docRef = await db.addDocument('learningGoals', goalData); 
                    appState.learningGoals.unshift({id: docRef.id, ...goalData});
                    showAlert('New learning goal added!', 'success'); 
                }
                renderLearningGoals();
                goalModal.hide();
            } catch(error) { 
                console.error("Save goal error:", error); 
                showAlert('Failed to save learning goal.', 'danger');
            } 
            finally { 
                setButtonLoading(saveBtn, false);
                setFormEnabled(document.getElementById('goal-form'), true);
            }
        }
        function openEmployeeProfileModal(employeeId) {
            const employee = appState.employees.find(e => e.id === employeeId); if (!employee) { showAlert("Could not find employee data.", "danger"); return; }
            document.getElementById('modal-profile-pic').src = employee.profilePic || `https://ui-avatars.com/api/?name=${employee.firstName}+${employee.lastName}&background=4361ee&color=fff&size=120`;
            document.getElementById('modal-profile-name').textContent = `${employee.firstName} ${employee.lastName}`;
            document.getElementById('modal-profile-role').textContent = employee.role.charAt(0).toUpperCase() + employee.role.slice(1);
            document.getElementById('modal-profile-email').textContent = employee.email || 'N/A';
            document.getElementById('modal-profile-phone').textContent = employee.phone || 'N/A';
            document.getElementById('modal-profile-address').textContent = employee.address || 'N/A';
            const deptName = allDepartments.find(d => d.id === employee.department)?.name || employee.department.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('modal-profile-department').textContent = deptName;
            document.getElementById('modal-profile-join-date').textContent = employee.joinDate || 'N/A';
            document.getElementById('modal-profile-status').innerHTML = `<span class="badge bg-${employee.status === 'active' ? 'success' : 'danger'}">${employee.status === 'active' ? 'Active' : 'Inactive'}</span>`;
            employeeProfileModal.show();
        }
    </script>
</body>
</html>
```
